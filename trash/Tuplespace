is_a Object
include Debuggable

# Tuplespace - Trash object wrapper for tuplespace.bash functionality
# Provides message-passing API for coordinated event-driven programming

# Source the tuplespace implementation
BASH_DIR="$(dirname "$TRASHDIR")/bash"
source "$BASH_DIR/tuplespace/tuplespace.bash"

# Initialize the tuplespace system
init() {
    [[ "${TRASH_DEBUG:-1}" != "0" ]] && debug "Initializing tuplespace system"
    ts_init
    echo "Tuplespace initialized at $TUPLESPACE_DIR"
}

# Put a tuple into the space
# Usage: @ Tuplespace put <type> <key1> <value1> [key2] [value2] ...
put() {
    local tuple_type="$1"
    shift
    [[ "${TRASH_DEBUG:-1}" != "0" ]] && debug "Putting tuple of type: $tuple_type"
    ts_put "$tuple_type" "$@"
}

# Get tuples matching criteria (read without removing)
# Usage: @ Tuplespace get <type> [key] [value]
get() {
    local tuple_type="$1"
    local key="$2"
    local value="$3"
    [[ "${TRASH_DEBUG:-1}" != "0" ]] && debug "Getting tuples of type: $tuple_type"
    ts_get "$tuple_type" "$key" "$value"
}

# Take tuples matching criteria (read and remove)
# Usage: @ Tuplespace take <type> [key] [value]
take() {
    local tuple_type="$1"
    local key="$2"
    local value="$3"
    [[ "${TRASH_DEBUG:-1}" != "0" ]] && debug "Taking tuples of type: $tuple_type"
    ts_take "$tuple_type" "$key" "$value"
}

# Wait for tuples matching criteria
# Usage: @ Tuplespace wait <type> [key] [value] [timeout]
wait() {
    local tuple_type="$1"
    local key="$2"
    local value="$3"
    local timeout="${4:-0}"
    [[ "${TRASH_DEBUG:-1}" != "0" ]] && debug "Waiting for tuples of type: $tuple_type (timeout: $timeout)"
    ts_wait "$tuple_type" "$key" "$value" "$timeout"
}

# Listen for events on tuples of a specific type
# Usage: @ Tuplespace listen <type> <command>
listen() {
    local tuple_type="$1"
    local command="$2"
    [[ "${TRASH_DEBUG:-1}" != "0" ]] && debug "Setting up listener for type: $tuple_type"
    ts_listen "$tuple_type" "$command"
}

# Stop a listener
# Usage: @ Tuplespace stopListener <type> <process_id>
stopListener() {
    local tuple_type="$1"
    local process_id="$2"
    [[ "${TRASH_DEBUG:-1}" != "0" ]] && debug "Stopping listener for type: $tuple_type, process: $process_id"
    ts_stop_listener "$tuple_type" "$process_id"
}

# Extract field from tuple record
# Usage: @ Tuplespace field <tuple_record> <field_name>
field() {
    local tuple_record="$1"
    local field_name="$2"
    ts_field "$tuple_record" "$field_name"
}

# List all tuples in the space
list() {
    [[ "${TRASH_DEBUG:-1}" != "0" ]] && debug "Listing all tuples"
    ts_list
}

# Count tuples by type
# Usage: @ Tuplespace count [type]
count() {
    local tuple_type="$1"
    if [[ -n "$tuple_type" ]]; then
        debug "Counting tuples of type: $tuple_type"
    else
        debug "Counting all tuples"
    fi
    ts_count "$tuple_type"
}

# Clear all tuples from the space
clear() {
    debug "Clearing all tuples from tuplespace"
    ts_clear
}

# Convenience methods for common patterns

# Put a key-value pair
# Usage: @ Tuplespace putKV <key> <value>
putKV() {
    local key="$1"
    local value="$2"
    debug "Putting key-value: $key = $value"
    ts_kv_put "$key" "$value"
}

# Get value by key
# Usage: @ Tuplespace getKV <key>
getKV() {
    local key="$1"
    debug "Getting value for key: $key"
    ts_kv_get "$key"
}

# Put an event
# Usage: @ Tuplespace putEvent <event_name> [data]
putEvent() {
    local event_name="$1"
    local data="${2:-}"
    debug "Putting event: $event_name"
    ts_event_put "$event_name" "$data"
}

# System information and diagnostics
info() {
    echo "=== Tuplespace System Information ==="
    echo "Directory: $TUPLESPACE_DIR"
    echo "Database: $TUPLESPACE_DB"
    echo "Events Dir: $TUPLESPACE_EVENTS_DIR"
    echo "Listeners Dir: $TUPLESPACE_LISTENERS_DIR"
    echo "Total tuples: $(ts_count)"
    echo ""
    echo "Tuple types:"
    if [[ -s "$TUPLESPACE_DB" ]]; then
        recsel "$TUPLESPACE_DB" | grep "^Type:" | sort | uniq -c | sed 's/^/  /'
    else
        echo "  (no tuples)"
    fi
}

# Show help for tuplespace operations
help() {
    echo "=== Tuplespace Commands ==="
    echo "Basic Operations:"
    echo "  @ Tuplespace put <type> <key1> <value1> ...  - Put tuple"
    echo "  @ Tuplespace get <type> [key] [value]        - Get tuples"
    echo "  @ Tuplespace take <type> [key] [value]       - Take tuples"
    echo "  @ Tuplespace wait <type> [key] [value] [timeout] - Wait for tuple"
    echo ""
    echo "Event System:"
    echo "  @ Tuplespace listen <type> <command>         - Listen for events"
    echo "  @ Tuplespace stopListener <type> <pid>       - Stop listener"
    echo ""
    echo "Convenience Methods:"
    echo "  @ Tuplespace putKV <key> <value>             - Put key-value"
    echo "  @ Tuplespace getKV <key>                     - Get value"
    echo "  @ Tuplespace putEvent <name> [data]          - Put event"
    echo ""
    echo "Utility:"
    echo "  @ Tuplespace list                            - List all tuples"
    echo "  @ Tuplespace count [type]                    - Count tuples"
    echo "  @ Tuplespace clear                           - Clear all tuples"
    echo "  @ Tuplespace field <tuple> <field>           - Extract field"
    echo "  @ Tuplespace info                            - System info"
    echo "  @ Tuplespace init                            - Initialize system"
    echo ""
    echo "Examples:"
    echo "  @ Tuplespace put person name Alice age 30"
    echo "  @ Tuplespace get person name Alice"
    echo "  @ Tuplespace putKV config.debug true"
    echo "  @ Tuplespace putEvent user_login alice@example.com"
}

# Run a demonstration of tuplespace capabilities
demo() {
    echo "=== Tuplespace Demo via Trash Object ==="

    # Initialize and clear
    init
    clear

    echo -e "\n1. Basic tuple operations..."
    put "person" "name" "Alice" "age" "30" "city" "NYC"
    put "person" "name" "Bob" "age" "25" "city" "SF"

    echo "   Added 2 person tuples"
    echo "   Total tuples: $(count)"

    echo -e "\n2. Querying tuples..."
    echo "   People in NYC:"
    get "person" "city" "NYC" | field - "name" | sed 's/^/     /'

    echo -e "\n3. Key-value operations..."
    putKV "app.debug" "true"
    putKV "app.timeout" "30"
    echo "   Config debug: $(getKV app.debug)"
    echo "   Config timeout: $(getKV app.timeout)"

    echo -e "\n4. Event operations..."
    putEvent "user_login" "alice@example.com"
    putEvent "user_login" "bob@example.com"
    echo "   Added 2 login events"
    echo "   Total events: $(count event)"

    echo -e "\n5. Taking (removing) tuples..."
    taken=$(take "person" "name" "Alice")
    if [[ -n "$taken" ]]; then
        echo "   Removed Alice from tuplespace"
    fi
    echo "   Remaining people: $(count person)"

    echo -e "\n6. Current system state:"
    info

    echo -e "\nDemo complete! Tuplespace is ready for use."
}

# Test the tuplespace functionality
test() {
    echo "=== Tuplespace Test Suite ==="

    local test_count=0
    local pass_count=0

    # Helper function for tests
    run_test() {
        local test_name="$1"
        local test_command="$2"
        local expected="$3"

        ((test_count++))
        echo -n "Test $test_count: $test_name... "

        local result
        result=$(eval "$test_command" 2>/dev/null)

        if [[ "$result" == "$expected" ]]; then
            echo "PASS"
            ((pass_count++))
        else
            echo "FAIL"
            echo "  Expected: '$expected'"
            echo "  Got: '$result'"
        fi
    }

    # Initialize clean environment
    init
    clear

    # Test basic operations
    run_test "Put tuple" "put test key value >/dev/null && echo 'success'" "success"
    run_test "Count tuples" "count test" "1"
    run_test "Get tuple" "get test key value | field - key" "key"
    run_test "Take tuple" "take test key value >/dev/null && count test" "0"

    # Test key-value operations
    run_test "Put KV" "putKV testkey testvalue >/dev/null && echo 'success'" "success"
    run_test "Get KV" "getKV testkey" "testvalue"

    # Test event operations
    run_test "Put event" "putEvent testevent testdata >/dev/null && echo 'success'" "success"
    run_test "Count events" "count event" "1"

    # Clean up
    clear

    echo ""
    echo "Test Results: $pass_count/$test_count tests passed"

    if [[ $pass_count -eq $test_count ]]; then
        echo "All tests PASSED! ✅"
        return 0
    else
        echo "Some tests FAILED! ❌"
        return 1
    fi
}
