package: Yutani

Transcript subclass: Yutani::Application
  instanceVars: outputView:'' inputField:'' layout:'' history:''

  # Override setup to build the UI
  method: setup [
    pragma: primitive
    local layout outputView inputField initialText

    # Store self in global for event handlers
    __TRANSCRIPT_SELF="$_RECEIVER"

    # Create layout
    layout=$(@ "$_RECEIVER" createVerticalLayout)
    _ivar_set layout "$layout"

    # Create output view with initial text
    initialText="Trashtalk Transcript
Type code and press Enter to evaluate. Ctrl+C to exit.
"
    outputView=$(@ "$_RECEIVER" createTextView: "Output" text: "$initialText")
    _ivar_set outputView "$outputView"
    _ivar_set history "$initialText"

    # Create input field
    inputField=$(@ "$_RECEIVER" createInputField: ">" placeholder: "Enter Trashtalk code...")
    _ivar_set inputField "$inputField"

    # Add widgets to layout
    @ "$layout" addChild: "$outputView"
    @ "$layout" addChild: "$inputField" fixedSize: 3 focus: true

    # Set root
    @ "$_RECEIVER" setRoot: "$layout"

    # Register event handlers using global reference
    @ "$inputField" onSubmitDo: '@ "$__TRANSCRIPT_SELF" evaluateInput: "$__TEXT"'
    @ "$_RECEIVER" onKeyDo: '@ "$__TRANSCRIPT_SELF" handleKey: "$__EVENT"'
  ]

  # Handle key events
  method: handleKey: event [
    pragma: primitive
    local event="$1" keyName inputField

    keyName=$(@ "$event" keyName)
    inputField="$(_ivar inputField)"

    case "$keyName" in
      KEY_CTRL_C|KEY_CTRL_D)
        @ "$_RECEIVER" stop
        ;;
      KEY_CTRL_L)
        @ "$_RECEIVER" clearOutput
        ;;
      KEY_TAB)
        @ "$inputField" focus
        ;;
      KEY_ESC)
        @ "$inputField" clear
        @ "$inputField" focus
        ;;
    esac
  ]

  # Evaluate input text
  method: evaluateInput: text [
    pragma: primitive
    local text="$1" result inputField newText

    if [[ -z "$text" ]]; then
      return
    fi

    inputField="$(_ivar inputField)"

    # Evaluate the code
    result=$(@ Trash eval: "$text" 2>&1)

    # Build output
    newText="> ${text}
${result}

"

    # Append to output
    @ "$_RECEIVER" appendOutput: "$newText"

    # Clear and refocus input
    @ "$inputField" clear
    @ "$inputField" focus
  ]

  # Append text to output
  method: appendOutput: text [
    pragma: primitive
    local text="$1" outputView history
    outputView="$(_ivar outputView)"
    history="$(_ivar history)"

    history="${history}${text}"
    _ivar_set history "$history"

    @ "$outputView" setText: "$history"
  ]

  # Clear output
  method: clearOutput [
    pragma: primitive
    local outputView
    outputView="$(_ivar outputView)"
    _ivar_set history ""
    @ "$outputView" clear
  ]
