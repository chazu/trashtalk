#!/usr/bin/env bash
# Generated by Trashtalk Compiler (jq) - DO NOT EDIT
# Source: Store.trash
# Generated: 2026-01-12T14:54:05

__Store__superclass="Object"
__Store__instanceVars=""
__Store__classInstanceVars=""
__Store__traits=""
__Store__sourceHash="dbfe9be895991a4c852469cc87b15282e3e516ace367dd381b02a971d71e7b69"
__Store__primitiveClass="1"

__Store__source() {
  cat <<'__TRASHTALK_SOURCE_EOF__'
# Store - OO wrapper for sqlite-json instance persistence
#
# Class methods (no instance needed):
#   @ Store init                              - Initialize database
#   @ Store createInstance <class> <id> <json> - Create instance
#   @ Store getInstance <id>                  - Get instance JSON
#   @ Store getField <id> <field>             - Get specific field
#   @ Store setField <id> <field> <value>     - Set specific field
#   @ Store deleteInstance <id>               - Delete instance
#   @ Store getClass <id>                     - Get instance class
#   @ Store findByClass <class>               - Find all of class
#   @ Store countByClass <class>              - Count instances
#   @ Store listClasses                       - List all classes
#   @ Store query <where>                     - Raw SQL query
#   @ Store ensureIndex <name> <path>         - Create virtual column + index

Store subclass: Object
  pragma: primitiveClass

  # Initialize the database
  primitiveClassMethod: init [
    db_init
  ]

  # Create a new instance
  # Usage: @ Store createInstance <class_name> <instance_id> <json_data>
  primitiveClassMethod: createInstance: class_name id: instance_id data: initial_data [
    local created_at full_data
    created_at=$(date +%s)
    full_data=$(echo "$initial_data" | jq -c ". + {class: \"$class_name\", created_at: \"$created_at\"}")
    db_put "$instance_id" "$full_data"
  ]

  # Get full instance JSON
  # Usage: @ Store getInstance <instance_id>
  primitiveClassMethod: getInstance: instance_id [
    db_get "$instance_id"
  ]

  # Get a specific field from instance
  # Usage: @ Store getField <instance_id> <field_name>
  primitiveClassMethod: getField: instance_id field: field [
    local data
    data=$(db_get "$instance_id")
    [[ -n "$data" ]] && echo "$data" | jq -r ".$field // empty"
  ]

  # Set a specific field on instance
  # Usage: @ Store setField <instance_id> <field_name> <value>
  primitiveClassMethod: setField: instance_id field: field value: value [
    local data updated
    data=$(db_get "$instance_id")
    if [[ -z "$data" ]]; then
      echo "Error: Instance $instance_id not found" >&2
      return 1
    fi
    if [[ "$value" =~ ^-?[0-9]+$ ]]; then
      updated=$(echo "$data" | jq -c ".$field = $value")
    else
      updated=$(echo "$data" | jq -c ".$field = \"$value\"")
    fi
    db_put "$instance_id" "$updated"
  ]

  # Delete an instance
  # Usage: @ Store deleteInstance <instance_id>
  primitiveClassMethod: deleteInstance: instance_id [
    db_delete "$instance_id"
  ]

  # Get the class of an instance
  # Usage: @ Store getClass <instance_id>
  primitiveClassMethod: getClass: instance_id [
    @ Store getField: "$instance_id" field: "class"
  ]

  # Check if an ID is a valid instance
  # Usage: @ Store isInstance <instance_id>
  primitiveClassMethod: isInstance: instance_id [
    local class_name
    class_name=$(@ Store getClass: "$instance_id")
    [[ -n "$class_name" ]]
  ]

  # Find all instances of a class
  # Usage: @ Store findByClass <class_name>
  primitiveClassMethod: findByClass: class_name [
    db_find_by_class "$class_name"
  ]

  # Count instances of a class
  # Usage: @ Store countByClass <class_name>
  primitiveClassMethod: countByClass: class_name [
    db_count_by_class "$class_name"
  ]

  # List all distinct classes
  # Usage: @ Store listClasses
  primitiveClassMethod: listClasses [
    db_list_classes
  ]

  # Raw query (returns instance IDs)
  # Usage: @ Store query <where_clause>
  primitiveClassMethod: query: where_clause [
    db_query "$where_clause"
  ]

  # Raw query returning full data
  # Usage: @ Store queryData <where_clause>
  primitiveClassMethod: queryData: where_clause [
    db_query_data "$where_clause"
  ]

  # Ensure a virtual column and index exist
  # Usage: @ Store ensureIndex <column_name> <json_path>
  primitiveClassMethod: ensureIndex: column_name path: json_path [
    db_ensure_virtual_column "$column_name" "$json_path" 2>/dev/null || true
    db_create_index "$column_name" 2>/dev/null || true
  ]

  # List all indices
  # Usage: @ Store listIndices
  primitiveClassMethod: listIndices [
    db_list_indices
  ]

  # List all columns
  # Usage: @ Store listColumns
  primitiveClassMethod: listColumns [
    db_list_columns
  ]

  # Clear all instance data (dangerous!)
  # Usage: @ Store clear
  primitiveClassMethod: clear [
    db_clear
  ]
__TRASHTALK_SOURCE_EOF__
}

__Store__class__init() {
    db_init
}

__Store__class__createInstance_id_data_() {
  local class_name="$1"
  local instance_id="$2"
  local initial_data="$3"
    local created_at full_data
    created_at=$(date +%s)
    full_data=$(echo "$initial_data" | jq -c ". + {class: \"$class_name\", created_at: \"$created_at\"}")
    db_put "$instance_id" "$full_data"
}

__Store__class__getInstance_() {
  local instance_id="$1"
    db_get "$instance_id"
}

__Store__class__getField_field_() {
  local instance_id="$1"
  local field="$2"
    local data
    data=$(db_get "$instance_id")
    [[ -n "$data" ]] && echo "$data" | jq -r ".$field // empty"
}

__Store__class__setField_field_value_() {
  local instance_id="$1"
  local field="$2"
  local value="$3"
    local data updated
    data=$(db_get "$instance_id")
    if [[ -z "$data" ]]; then
        echo "Error: Instance $instance_id not found" >&2
        return 1
    fi
    if [[ "$value" =~ ^-?[0-9]+$ ]]; then
        updated=$(echo "$data" | jq -c ".$field=$value")
        else
        updated=$(echo "$data" | jq -c ".$field = \"$value\"")
    fi
    db_put "$instance_id" "$updated"
}

__Store__class__deleteInstance_() {
  local instance_id="$1"
    db_delete "$instance_id"
}

__Store__class__getClass_() {
  local instance_id="$1"
    @ Store getField: "$instance_id" field: "class"
}

__Store__class__isInstance_() {
  local instance_id="$1"
    local class_name
    class_name=$(@ Store getClass: "$instance_id")
    [[ -n "$class_name" ]]
}

__Store__class__findByClass_() {
  local class_name="$1"
    db_find_by_class "$class_name"
}

__Store__class__countByClass_() {
  local class_name="$1"
    db_count_by_class "$class_name"
}

__Store__class__listClasses() {
    db_list_classes
}

__Store__class__query_() {
  local where_clause="$1"
    db_query "$where_clause"
}

__Store__class__queryData_() {
  local where_clause="$1"
    db_query_data "$where_clause"
}

__Store__class__ensureIndex_path_() {
  local column_name="$1"
  local json_path="$2"
    db_ensure_virtual_column "$column_name" "$json_path" 2>/dev/null || true
    db_create_index "$column_name" 2>/dev/null || true
}

__Store__class__listIndices() {
    db_list_indices
}

__Store__class__listColumns() {
    db_list_columns
}

__Store__class__clear() {
    db_clear
}
