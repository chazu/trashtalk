#!/usr/bin/env bash
# Generated by Trashtalk Compiler (jq) - DO NOT EDIT
# Source: Application.trash
# Generated: 2026-01-13T02:47:50

__Yutani__Application__superclass="Object"
__Yutani__Application__instanceVars="session: dispatcher: rootWidget: running:"
__Yutani__Application__classInstanceVars=""
__Yutani__Application__traits=""
__Yutani__Application__sourceHash="03cb7e47cfd62d28f21446ddf9882cad535ce836d2f94947308db1f68981c323"
__Yutani__Application__package="Yutani"
__Yutani__Application__qualifiedName="Yutani::Application"

__Yutani__Application__source() {
  cat <<'__TRASHTALK_SOURCE_EOF__'
package: Yutani

Application subclass: Object
  instanceVars: session:'' dispatcher:'' rootWidget:'' running:''

  # Launch application on default host
  classMethod: launch [
    @ self launchOn: 'localhost:7755'
  ]

  # Launch application on specified host (bash-specific: error handling, grep)
  rawClassMethod: launchOn: host [
    pragma: bashOnly
    local host="$1"
    local app session dispatcher

    # Create application instance
    app=$(@ "$_CLASS" new)

    # Connect to Yutani
    session=$(@ Yutani::Session connectTo: "$host" 2>&1 | grep -v "^\[INFO\]" | tail -1)
    if [[ -z "$session" ]] || echo "$session" | grep -qi error; then
      echo "Error: Could not connect to Yutani server at $host" >&2
      return 1
    fi

    # Create dispatcher
    dispatcher=$(@ Yutani::EventDispatcher new)

    # Set up application
    @ "$app" _setSession: "$session"
    @ "$app" _setDispatcher: "$dispatcher"
    @ "$app" _setRunning: "true"

    # Call user's setup method
    @ "$app" setup

    # Run event loop
    @ "$app" run

    # Cleanup
    @ "$app" cleanup
  ]

  # Subclasses override this to build UI
  method: setup [
    :
  ]

  # Main event loop - tries native streaming first, falls back to coproc
  # (bash-specific: error redirection)
  rawMethod: run [
    pragma: bashOnly
    # Try native streaming first (requires native GrpcClient.dylib and daemon)
    # Falls back to coproc-based streaming if native fails
    if @ "$_RECEIVER" _tryNativeEventLoop 2>/dev/null; then
      return 0
    fi

    # Fallback: coproc-based event loop
    @ "$_RECEIVER" _runCoprocEventLoop
  ]

  # Native event loop using GrpcClient.serverStream
  method: _tryNativeEventLoop [
    @ session runEventLoopWithDispatcher: dispatcher
  ]

  # Fallback: coproc-based event loop (uses grpcurl subprocess)
  # (bash-specific: globals for handler access)
  rawMethod: _runCoprocEventLoop [
    pragma: bashOnly
    # Store dispatcher in global for handler access
    __APP_DISPATCHER="$(_ivar dispatcher)"
    __APP_INSTANCE="$_RECEIVER"

    # Use session's event handling with a dispatcher handler
    @ "$(_ivar session)" onEventDo: '
      @ "$__APP_DISPATCHER" dispatchJson: "$__COPROC_LINE"
      if [[ $(@ "$__APP_DISPATCHER" isRunning) != "true" ]]; then
        @ "$__APP_INSTANCE" stop
      fi
    '
  ]

  # Stop the application
  method: stop [
    running := 'false'
  ]

  # Cleanup resources
  method: cleanup [
    (dispatcher notEmpty) ifTrue: [
      @ dispatcher cleanup
    ].
    (session notEmpty) ifTrue: [
      @ session disconnect
    ]
  ]

  # === Widget Creation Helpers ===
  # These create widgets with dispatcher already set

  method: createTextView: title [
    | widget |
    widget := $(@ Yutani::TextView titled: title inSession: session).
    @ widget setDispatcher: dispatcher.
    ^ widget
  ]

  method: createTextView: title text: initialText [
    | widget |
    widget := $(@ Yutani::TextView titled: title text: initialText inSession: session).
    @ widget setDispatcher: dispatcher.
    ^ widget
  ]

  method: createInputField: label [
    | widget |
    widget := $(@ Yutani::InputField labeled: label inSession: session).
    @ widget setDispatcher: dispatcher.
    ^ widget
  ]

  method: createInputField: label placeholder: placeholder [
    | widget |
    widget := $(@ Yutani::InputField labeled: label placeholder: placeholder inSession: session).
    @ widget setDispatcher: dispatcher.
    ^ widget
  ]

  method: createListView: title [
    | widget |
    widget := $(@ Yutani::ListView titled: title inSession: session).
    @ widget setDispatcher: dispatcher.
    ^ widget
  ]

  method: createVerticalLayout [
    | widget |
    widget := $(@ Yutani::VerticalLayout inSession: session).
    @ widget setDispatcher: dispatcher.
    ^ widget
  ]

  method: createHorizontalLayout [
    | widget |
    widget := $(@ Yutani::HorizontalLayout inSession: session).
    @ widget setDispatcher: dispatcher.
    ^ widget
  ]

  # Set root widget
  method: setRoot: widget [
    rootWidget := widget
    @ widget setAsRoot
  ]

  # === Event Handler Registration ===

  # Register global key handler
  method: onKeyDo: handler [
    @ dispatcher onKeyDo: handler
  ]

  # Register global mouse handler
  method: onMouseDo: handler [
    @ dispatcher onMouseDo: handler
  ]

  # Accessors
  method: getSession [ ^ session ]
  method: getDispatcher [ ^ dispatcher ]
  method: getRootWidget [ ^ rootWidget ]

  # Private setters
  method: _setSession: v [ session := v ]
  method: _setDispatcher: v [ dispatcher := v ]
  method: _setRunning: v [ running := v ]
__TRASHTALK_SOURCE_EOF__
}

__Yutani__Application__session() {
  echo "$(_ivar session)"; return
}

__Yutani__Application__session_() {
  _ivar_set session "$1"
}

__Yutani__Application__getSession() {
  echo "$(_ivar session)"; return
}

__Yutani__Application__setSession_() {
  _ivar_set session "$1"
}
__Yutani__Application__dispatcher() {
  echo "$(_ivar dispatcher)"; return
}

__Yutani__Application__dispatcher_() {
  _ivar_set dispatcher "$1"
}

__Yutani__Application__getDispatcher() {
  echo "$(_ivar dispatcher)"; return
}

__Yutani__Application__setDispatcher_() {
  _ivar_set dispatcher "$1"
}
__Yutani__Application__rootWidget() {
  echo "$(_ivar rootWidget)"; return
}

__Yutani__Application__rootWidget_() {
  _ivar_set rootWidget "$1"
}

__Yutani__Application__getRootWidget() {
  echo "$(_ivar rootWidget)"; return
}

__Yutani__Application__setRootWidget_() {
  _ivar_set rootWidget "$1"
}
__Yutani__Application__running() {
  echo "$(_ivar running)"; return
}

__Yutani__Application__running_() {
  _ivar_set running "$1"
}

__Yutani__Application__getRunning() {
  echo "$(_ivar running)"; return
}

__Yutani__Application__setRunning_() {
  _ivar_set running "$1"
}

__Yutani__Application__class__launch() {
  @ "$_RECEIVER" launchOn: 'localhost:7755'
}

declare -g __Yutani__Application__class__launchOn___bashOnly=1
__Yutani__Application__class__launchOn_() {
  local host="$1"
    local host="$1"
    local app session dispatcher

    # Create application instance
    app=$(@ "$_CLASS" new)

    # Connect to Yutani
    session=$(@ Yutani::Session connectTo: "$host" 2>&1 | grep -v "^\[INFO\]" | tail -1)
    if [[ -z "$session" ]] || echo "$session" | grep -qi error; then
        echo "Error: Could not connect to Yutani server at $host" >&2
        return 1
    fi

    # Create dispatcher
    dispatcher=$(@ Yutani::EventDispatcher new)

    # Set up application
    @ "$app" _setSession: "$session"
    @ "$app" _setDispatcher: "$dispatcher"
    @ "$app" _setRunning: "true"

    # Call user's setup method
    @ "$app" setup

    # Run event loop
    @ "$app" run

    # Cleanup
    @ "$app" cleanup
}

__Yutani__Application__setup() {
  :
}

declare -g __Yutani__Application__run__bashOnly=1
__Yutani__Application__run() {
    # Try native streaming first (requires native GrpcClient.dylib and daemon)
    # Falls back to coproc-based streaming if native fails
    if @ "$_RECEIVER" _tryNativeEventLoop 2>/dev/null; then
        return 0
    fi

    # Fallback: coproc-based event loop
    @ "$_RECEIVER" _runCoprocEventLoop
}

__Yutani__Application___tryNativeEventLoop() {
  @ "$(_ivar session)" runEventLoopWithDispatcher: "$(_ivar dispatcher)"
}

declare -g __Yutani__Application___runCoprocEventLoop__bashOnly=1
__Yutani__Application___runCoprocEventLoop() {
    # Store dispatcher in global for handler access
    __APP_DISPATCHER="$(_ivar dispatcher)"
    __APP_INSTANCE="$_RECEIVER"

    # Use session's event handling with a dispatcher handler
    @ "$(_ivar session)" onEventDo: '
    @ "$__APP_DISPATCHER" dispatchJson: "$__COPROC_LINE"
    if [[ $(@ "$__APP_DISPATCHER" isRunning) != "true" ]]; then
        @ "$__APP_INSTANCE" stop
    fi
    '
}

__Yutani__Application__stop() {
  _ivar_set running "false"
}

__Yutani__Application__cleanup() {
  if [[ -n "$(_ivar dispatcher)" ]]; then @ "$(_ivar dispatcher)" cleanup; fi
  if [[ -n "$(_ivar session)" ]]; then @ "$(_ivar session)" disconnect; fi
}

__Yutani__Application__createTextView_() {
  local title="$1"
  local widget
  widget="$(@ Yutani::TextView titled: title inSession: session)"
  @ "$widget" setDispatcher: "$(_ivar dispatcher)"
  echo "$widget"; return
}

__Yutani__Application__createTextView_text_() {
  local title="$1"
  local initialText="$2"
  local widget
  widget="$(@ Yutani::TextView titled: title text: initialText inSession: session)"
  @ "$widget" setDispatcher: "$(_ivar dispatcher)"
  echo "$widget"; return
}

__Yutani__Application__createInputField_() {
  local label="$1"
  local widget
  widget="$(@ Yutani::InputField labeled: label inSession: session)"
  @ "$widget" setDispatcher: "$(_ivar dispatcher)"
  echo "$widget"; return
}

__Yutani__Application__createInputField_placeholder_() {
  local label="$1"
  local placeholder="$2"
  local widget
  widget="$(@ Yutani::InputField labeled: label placeholder: placeholder inSession: session)"
  @ "$widget" setDispatcher: "$(_ivar dispatcher)"
  echo "$widget"; return
}

__Yutani__Application__createListView_() {
  local title="$1"
  local widget
  widget="$(@ Yutani::ListView titled: title inSession: session)"
  @ "$widget" setDispatcher: "$(_ivar dispatcher)"
  echo "$widget"; return
}

__Yutani__Application__createVerticalLayout() {
  local widget
  widget="$(@ Yutani::VerticalLayout inSession: session)"
  @ "$widget" setDispatcher: "$(_ivar dispatcher)"
  echo "$widget"; return
}

__Yutani__Application__createHorizontalLayout() {
  local widget
  widget="$(@ Yutani::HorizontalLayout inSession: session)"
  @ "$widget" setDispatcher: "$(_ivar dispatcher)"
  echo "$widget"; return
}

__Yutani__Application__setRoot_() {
  local widget="$1"
  _ivar_set rootWidget "$widget"
  @ "$widget" setAsRoot
}

__Yutani__Application__onKeyDo_() {
  local handler="$1"
  @ "$(_ivar dispatcher)" onKeyDo: "$handler"
}

__Yutani__Application__onMouseDo_() {
  local handler="$1"
  @ "$(_ivar dispatcher)" onMouseDo: "$handler"
}

__Yutani__Application__getSession() {
  echo session
}

__Yutani__Application__getDispatcher() {
  echo dispatcher
}

__Yutani__Application__getRootWidget() {
  echo rootWidget
}

__Yutani__Application___setSession_() {
  local v="$1"
  _ivar_set session "$v"
}

__Yutani__Application___setDispatcher_() {
  local v="$1"
  _ivar_set dispatcher "$v"
}

__Yutani__Application___setRunning_() {
  local v="$1"
  _ivar_set running "$v"
}
