#!/usr/bin/env bash
# Generated by Trashtalk Compiler (jq) - DO NOT EDIT
# Source: Session.trash
# Generated: 2026-01-08T21:39:45

__Yutani__Session__superclass="Object"
__Yutani__Session__instanceVars="sessionId: host:localhost:7755 eventCoproc: grpcClient:"
__Yutani__Session__classInstanceVars=""
__Yutani__Session__traits=""
__Yutani__Session__sourceHash="83bce9691a147aa67e9619a88fc819fded5a1f43a4622f8eb8142204c08c7279"
__Yutani__Session__package="Yutani"
__Yutani__Session__qualifiedName="Yutani::Session"

__Yutani__Session__source() {
  cat <<'__TRASHTALK_SOURCE_EOF__'
package: Yutani

# Yutani Session - manages connection to Yutani UI server
# Refactored to use GrpcClient for connection pooling and native Procyon support

Session subclass: Object
  instanceVars: sessionId:'' host:'localhost:7755' eventCoproc:'' grpcClient:''

  # ============================================================================
  # Factory Methods
  # ============================================================================

  rawClassMethod: connectTo: host [
    local host="$1"
    local session client response sid

    # Create GrpcClient with pooling enabled
    client=$(@ GrpcClient connectTo: "$host")
    @ "$client" enablePooling

    # Create session instance
    session=$(@ Yutani::Session new)
    @ "$session" _setHost: "$host"
    @ "$session" _setGrpcClient: "$client"

    # Create session on server
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.SessionService/CreateSession' \
      with: '{"client_name": "trashtalk"}')
    sid=$(echo "$response" | jq -r '.sessionId.id')
    @ "$session" _setSessionId: "$sid"

    echo "$session"
  ]

  rawClassMethod: connect [
    @ Yutani::Session connectTo: 'localhost:7755'
  ]

  # ============================================================================
  # Accessors
  # ============================================================================

  method: getSessionId [ ^ sessionId ]
  method: getHost [ ^ host ]
  method: getGrpcClient [ ^ grpcClient ]

  # ============================================================================
  # Session Lifecycle
  # ============================================================================

  method: disconnect [
    @ self destroySession.
    @ self stopEventStream
  ]

  rawMethod: destroySession [
    local sid client json
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")")
    @ "$client" call: 'industries.loosh.yutani.v1.SessionService/DestroySession' with: "$json"
  ]

  rawMethod: ping [
    local ts client json
    ts=$(date +%s)
    client="$(_ivar grpcClient)"
    json=$(jo timestamp="$ts")
    @ "$client" call: 'industries.loosh.yutani.v1.SessionService/Ping' with: "$json"
  ]

  rawMethod: serverInfo [
    local client
    client="$(_ivar grpcClient)"
    @ "$client" call: 'industries.loosh.yutani.v1.SessionService/GetServerInfo' with: '{}'
  ]

  # ============================================================================
  # Screen Operations
  # ============================================================================

  rawMethod: screenSize [
    local sid client json
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")")
    @ "$client" call: 'industries.loosh.yutani.v1.ScreenService/GetSize' with: "$json"
  ]

  rawMethod: clearScreen [
    local sid client json
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")")
    @ "$client" call: 'industries.loosh.yutani.v1.ScreenService/Clear' with: "$json"
  ]

  rawMethod: sync [
    local sid client json
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")")
    @ "$client" call: 'industries.loosh.yutani.v1.ScreenService/Sync' with: "$json"
  ]

  # ============================================================================
  # Widget Creation
  # ============================================================================

  rawMethod: createList: title [
    local sid client json response title="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_LIST" properties="$(jo border=true title="$title")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: createTextView: title [
    local sid client json response title="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_TEXT_VIEW" \
      properties="$(jo border=true title="$title" \
        text_view="$(jo word_wrap=true dynamic_colors=true)")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: createTextViewWithText: title text: text [
    local sid client json response title="$1" text="$2"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_TEXT_VIEW" \
      properties="$(jo border=true title="$title" \
        text_view="$(jo -- -s text="$text" word_wrap=true dynamic_colors=true)")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: createInputField: label [
    local sid client json response label="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_INPUT_FIELD" \
      properties="$(jo border=true input_field="$(jo -- -s label="$label" -s placeholder="" -s text="")")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: createInputFieldWithPlaceholder: label placeholder: placeholder [
    local sid client json response label="$1" placeholder="$2"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_INPUT_FIELD" \
      properties="$(jo border=true input_field="$(jo -- -s label="$label" -s placeholder="$placeholder" -s text="")")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: createHorizontalLayout [
    local sid client json response
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    # FLEX_COLUMN = items side by side (horizontal)
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_FLEX" \
      properties="$(jo flex="$(jo direction="FLEX_COLUMN")")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: createVerticalLayout [
    local sid client json response
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    # FLEX_ROW = items stacked vertically (top to bottom)
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_FLEX" \
      properties="$(jo flex="$(jo direction="FLEX_ROW")")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
  ]

  # ============================================================================
  # Widget Operations
  # ============================================================================

  rawMethod: setText: text on: widgetId [
    local sid client json text="$1" widgetId="$2"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")" \
      properties="$(jo text_view="$(jo -- -s text="$text")")")
    @ "$client" call: 'industries.loosh.yutani.v1.WidgetService/SetProperties' with: "$json"
  ]

  rawMethod: setInputText: text on: widgetId [
    local sid client json text="$1" widgetId="$2"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")" \
      properties="$(jo input_field="$(jo -- -s text="$text")")")
    @ "$client" call: 'industries.loosh.yutani.v1.WidgetService/SetProperties' with: "$json"
  ]

  rawMethod: getInputText: widgetId [
    local sid client json response widgetId="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/GetProperties' with: "$json")
    # Try both camelCase and snake_case field names
    echo "$response" | jq -r '.properties.inputField.text // .properties.input_field.text // ""'
  ]

  rawMethod: focusWidget: widgetId [
    local sid client json widgetId="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    @ "$client" call: 'industries.loosh.yutani.v1.WidgetService/SetFocus' with: "$json"
  ]

  rawMethod: setRoot: widgetId [
    local sid client json widgetId="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    @ "$client" call: 'industries.loosh.yutani.v1.WidgetService/SetRoot' with: "$json"
  ]

  rawMethod: listWidgets [
    local sid client json
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")")
    @ "$client" call: 'industries.loosh.yutani.v1.WidgetService/ListWidgets' with: "$json"
  ]

  rawMethod: deleteWidget: widgetId [
    local sid client json widgetId="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    @ "$client" call: 'industries.loosh.yutani.v1.WidgetService/DeleteWidget' with: "$json"
  ]

  # ============================================================================
  # List Operations
  # ============================================================================

  rawMethod: addItem: mainText to: listId [
    local sid client json mainText="$1" listId="$2"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$listId")" main_text="$mainText")
    @ "$client" call: 'industries.loosh.yutani.v1.ListService/AddItem' with: "$json"
  ]

  rawMethod: addItem: mainText secondary: secondaryText to: listId [
    local sid client json mainText="$1" secondaryText="$2" listId="$3"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$listId")" \
      main_text="$mainText" secondary_text="$secondaryText")
    @ "$client" call: 'industries.loosh.yutani.v1.ListService/AddItem' with: "$json"
  ]

  rawMethod: clearList: listId [
    local sid client json listId="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$listId")")
    @ "$client" call: 'industries.loosh.yutani.v1.ListService/Clear' with: "$json"
  ]

  # ============================================================================
  # Layout Operations
  # ============================================================================

  rawMethod: addChild: childId to: layoutId [
    local sid client json childId="$1" layoutId="$2"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" flex_id="$(jo id="$layoutId")" item_id="$(jo id="$childId")" proportion=1 fixed_size=0 focus=false)
    @ "$client" call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: "$json"
  ]

  rawMethod: addChild: childId to: layoutId fixedSize: size [
    local sid client json childId="$1" layoutId="$2" size="$3"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" flex_id="$(jo id="$layoutId")" item_id="$(jo id="$childId")" proportion=0 fixed_size="$size" focus=false)
    @ "$client" call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: "$json"
  ]

  rawMethod: addChild: childId to: layoutId fixedSize: size focus: shouldFocus [
    local sid client json childId="$1" layoutId="$2" size="$3" shouldFocus="$4"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" flex_id="$(jo id="$layoutId")" item_id="$(jo id="$childId")" proportion=0 fixed_size="$size" focus="$shouldFocus")
    @ "$client" call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: "$json"
  ]

  # ============================================================================
  # Event Streaming - Native (preferred) or Coproc (fallback)
  # ============================================================================

  # Native streaming using GrpcClient.serverStream (requires native daemon)
  # This is the preferred method - uses persistent gRPC connection, no subprocess
  # The block receives JSON event data for each streamed message
  rawMethod: streamEventsWithBlock: block [
    pragma: direct
    local sid client filter_json
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"

    # Build filter JSON for Subscribe request
    filter_json=$(jo session_id="$(jo id="$sid")" \
      filter="$(jo receive_key_events=true receive_mouse_events=true \
        receive_resize_events=true receive_focus_events=true receive_widget_events=true)")

    # Use native streaming - blocks until stream ends, calls block for each message
    @ "$client" serverStream: 'industries.loosh.yutani.v1.EventService/Subscribe' \
      with: "$filter_json" \
      handler: "$1"
  ]

  # High-level streaming with EventDispatcher integration
  # Creates Event objects and dispatches them through the provided dispatcher
  # Usage: @ $session runEventLoopWithDispatcher: $dispatcher
  rawMethod: runEventLoopWithDispatcher: dispatcher [
    pragma: direct
    local dispatcher="$1" handlerBlock

    # Create a block that converts JSON to Event and dispatches it
    handlerBlock=$(@ Block new: "
      local json=\"\$1\"
      @ \"$dispatcher\" dispatchJson: \"\$json\"
    ")

    # Start streaming - this blocks until stream ends/errors
    @ "$_RECEIVER" streamEventsWithBlock: "$handlerBlock"
  ]

  # ============================================================================
  # Fallback: Coproc-based streaming (for when native daemon unavailable)
  # ============================================================================

  rawMethod: startEventStream [
    local sid filter_json host evt_coproc cmd
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"

    # Build filter JSON
    filter_json=$(jo session_id="$(jo id="$sid")" \
      filter="$(jo receive_key_events=true receive_mouse_events=true \
        receive_resize_events=true receive_focus_events=true receive_widget_events=true)")

    # Build the grpcurl command - pipe through jq -c to get compact single-line JSON
    # Use --unbuffered to prevent jq from buffering output
    cmd="grpcurl -plaintext -d '$filter_json' $host industries.loosh.yutani.v1.EventService/Subscribe | jq --unbuffered -c ."

    # Create and start coproc
    evt_coproc=$(@ Coproc for: "$cmd")
    @ "$evt_coproc" startReadOnly

    _ivar_set eventCoproc "$evt_coproc"
  ]

  rawMethod: stopEventStream [
    local evt_coproc
    evt_coproc="$(_ivar eventCoproc)"

    if [[ -n "$evt_coproc" ]]; then
      @ "$evt_coproc" terminate
      _ivar_set eventCoproc ""
    fi
  ]

  # Process events with a handler (coproc mode). Handler can read $__COPROC_LINE.
  # Usage: @ $session onEventDo: '@ $obj handleEvent'
  rawMethod: onEventDo: handler [
    local evt_coproc handler="$1"
    evt_coproc="$(_ivar eventCoproc)"

    # Start stream if not already running
    if [[ -z "$evt_coproc" ]]; then
      @ "$_RECEIVER" startEventStream
      evt_coproc="$(_ivar eventCoproc)"
    fi

    # Read lines continuously, calling handler for each
    @ "$evt_coproc" readLinesDo: "$handler"
  ]

  rawMethod: nextEvent [
    local evt_coproc line
    evt_coproc="$(_ivar eventCoproc)"

    # Start stream if not already running
    if [[ -z "$evt_coproc" ]]; then
      @ "$_RECEIVER" startEventStream
      evt_coproc="$(_ivar eventCoproc)"
    fi

    # Read next line (blocks until event arrives)
    line=$(@ "$evt_coproc" readLine)
    echo "$line"
  ]

  # ============================================================================
  # Private Setters
  # ============================================================================

  method: _setHost: v [ host := v ]
  method: _setSessionId: v [ sessionId := v ]
  method: _setGrpcClient: v [ grpcClient := v ]
__TRASHTALK_SOURCE_EOF__
}

__Yutani__Session__sessionId() {
  echo "$(_ivar sessionId)"; return
}

__Yutani__Session__sessionId_() {
  _ivar_set sessionId "$1"
}

__Yutani__Session__getSessionId() {
  echo "$(_ivar sessionId)"; return
}

__Yutani__Session__setSessionId_() {
  _ivar_set sessionId "$1"
}
__Yutani__Session__host() {
  echo "$(_ivar host)"; return
}

__Yutani__Session__host_() {
  _ivar_set host "$1"
}

__Yutani__Session__getHost() {
  echo "$(_ivar host)"; return
}

__Yutani__Session__setHost_() {
  _ivar_set host "$1"
}
__Yutani__Session__eventCoproc() {
  echo "$(_ivar eventCoproc)"; return
}

__Yutani__Session__eventCoproc_() {
  _ivar_set eventCoproc "$1"
}

__Yutani__Session__getEventCoproc() {
  echo "$(_ivar eventCoproc)"; return
}

__Yutani__Session__setEventCoproc_() {
  _ivar_set eventCoproc "$1"
}
__Yutani__Session__grpcClient() {
  echo "$(_ivar grpcClient)"; return
}

__Yutani__Session__grpcClient_() {
  _ivar_set grpcClient "$1"
}

__Yutani__Session__getGrpcClient() {
  echo "$(_ivar grpcClient)"; return
}

__Yutani__Session__setGrpcClient_() {
  _ivar_set grpcClient "$1"
}

__Yutani__Session__class__connectTo_() {
  local host="$1"
    local host="$1"
    local session client response sid

    # Create GrpcClient with pooling enabled
    client=$(@ GrpcClient connectTo: "$host")
    @ "$client" enablePooling

    # Create session instance
    session=$(@ Yutani::Session new)
    @ "$session" _setHost: "$host"
    @ "$session" _setGrpcClient: "$client"

    # Create session on server
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.SessionService/CreateSession' \
        with: '{"client_name": "trashtalk"}')
    sid=$(echo "$response" | jq -r '.sessionId.id')
    @ "$session" _setSessionId: "$sid"

    echo "$session"
}

__Yutani__Session__class__connect() {
    @ Yutani :: Session connectTo: 'localhost:7755'
}

__Yutani__Session__getSessionId() {
  echo sessionId
}

__Yutani__Session__getHost() {
  echo host
}

__Yutani__Session__getGrpcClient() {
  echo grpcClient
}

__Yutani__Session__disconnect() {
  @ "$_RECEIVER" destroySession
  @ "$_RECEIVER" stopEventStream
}

__Yutani__Session__destroySession() {
    local sid client json
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")")
    @ "$client" call: 'industries.loosh.yutani.v1.SessionService/DestroySession' with: "$json"
}

__Yutani__Session__ping() {
    local ts client json
    ts=$(date +%s)
    client="$(_ivar grpcClient)"
    json=$(jo timestamp="$ts")
    @ "$client" call: 'industries.loosh.yutani.v1.SessionService/Ping' with: "$json"
}

__Yutani__Session__serverInfo() {
    local client
    client="$(_ivar grpcClient)"
    @ "$client" call: 'industries.loosh.yutani.v1.SessionService/GetServerInfo' with: '{}'
}

__Yutani__Session__screenSize() {
    local sid client json
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")")
    @ "$client" call: 'industries.loosh.yutani.v1.ScreenService/GetSize' with: "$json"
}

__Yutani__Session__clearScreen() {
    local sid client json
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")")
    @ "$client" call: 'industries.loosh.yutani.v1.ScreenService/Clear' with: "$json"
}

__Yutani__Session__sync() {
    local sid client json
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")")
    @ "$client" call: 'industries.loosh.yutani.v1.ScreenService/Sync' with: "$json"
}

__Yutani__Session__createList_() {
  local title="$1"
    local sid client json response title="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_LIST" properties="$(jo border=true title="$title")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__createTextView_() {
  local title="$1"
    local sid client json response title="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_TEXT_VIEW" \
        properties="$(jo border=true title="$title" \
        text_view="$(jo word_wrap=true dynamic_colors=true)")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__createTextViewWithText_text_() {
  local title="$1"
  local text="$2"
    local sid client json response title="$1" text="$2"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_TEXT_VIEW" \
        properties="$(jo border=true title="$title" \
        text_view="$(jo -- -s text="$text" word_wrap=true dynamic_colors=true)")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__createInputField_() {
  local label="$1"
    local sid client json response label="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_INPUT_FIELD" \
        properties="$(jo border=true input_field="$(jo -- -s label="$label" -s placeholder="" -s text="")")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__createInputFieldWithPlaceholder_placeholder_() {
  local label="$1"
  local placeholder="$2"
    local sid client json response label="$1" placeholder="$2"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_INPUT_FIELD" \
        properties="$(jo border=true input_field="$(jo -- -s label="$label" -s placeholder="$placeholder" -s text="")")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__createHorizontalLayout() {
    local sid client json response
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    # FLEX_COLUMN= items side by side (horizontal)
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_FLEX" \
        properties="$(jo flex="$(jo direction="FLEX_COLUMN")")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__createVerticalLayout() {
    local sid client json response
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    # FLEX_ROW= items stacked vertically (top to bottom)
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_FLEX" \
        properties="$(jo flex="$(jo direction="FLEX_ROW")")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__setText_on_() {
  local text="$1"
  local widgetId="$2"
    local sid client json text="$1" widgetId="$2"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")" \
        properties="$(jo text_view="$(jo -- -s text="$text")")")
    @ "$client" call: 'industries.loosh.yutani.v1.WidgetService/SetProperties' with: "$json"
}

__Yutani__Session__setInputText_on_() {
  local text="$1"
  local widgetId="$2"
    local sid client json text="$1" widgetId="$2"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")" \
        properties="$(jo input_field="$(jo -- -s text="$text")")")
    @ "$client" call: 'industries.loosh.yutani.v1.WidgetService/SetProperties' with: "$json"
}

__Yutani__Session__getInputText_() {
  local widgetId="$1"
    local sid client json response widgetId="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    response=$(@ "$client" call: 'industries.loosh.yutani.v1.WidgetService/GetProperties' with: "$json")
    # Try both camelCase and snake_case field names
    echo "$response" | jq -r '.properties.inputField.text // .properties.input_field.text // ""'
}

__Yutani__Session__focusWidget_() {
  local widgetId="$1"
    local sid client json widgetId="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    @ "$client" call: 'industries.loosh.yutani.v1.WidgetService/SetFocus' with: "$json"
}

__Yutani__Session__setRoot_() {
  local widgetId="$1"
    local sid client json widgetId="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    @ "$client" call: 'industries.loosh.yutani.v1.WidgetService/SetRoot' with: "$json"
}

__Yutani__Session__listWidgets() {
    local sid client json
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")")
    @ "$client" call: 'industries.loosh.yutani.v1.WidgetService/ListWidgets' with: "$json"
}

__Yutani__Session__deleteWidget_() {
  local widgetId="$1"
    local sid client json widgetId="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    @ "$client" call: 'industries.loosh.yutani.v1.WidgetService/DeleteWidget' with: "$json"
}

__Yutani__Session__addItem_to_() {
  local mainText="$1"
  local listId="$2"
    local sid client json mainText="$1" listId="$2"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$listId")" main_text="$mainText")
    @ "$client" call: 'industries.loosh.yutani.v1.ListService/AddItem' with: "$json"
}

__Yutani__Session__addItem_secondary_to_() {
  local mainText="$1"
  local secondaryText="$2"
  local listId="$3"
    local sid client json mainText="$1" secondaryText="$2" listId="$3"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$listId")" \
        main_text="$mainText" secondary_text="$secondaryText")
    @ "$client" call: 'industries.loosh.yutani.v1.ListService/AddItem' with: "$json"
}

__Yutani__Session__clearList_() {
  local listId="$1"
    local sid client json listId="$1"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$listId")")
    @ "$client" call: 'industries.loosh.yutani.v1.ListService/Clear' with: "$json"
}

__Yutani__Session__addChild_to_() {
  local childId="$1"
  local layoutId="$2"
    local sid client json childId="$1" layoutId="$2"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" flex_id="$(jo id="$layoutId")" item_id="$(jo id="$childId")" proportion=1 fixed_size=0 focus=false)
    @ "$client" call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: "$json"
}

__Yutani__Session__addChild_to_fixedSize_() {
  local childId="$1"
  local layoutId="$2"
  local size="$3"
    local sid client json childId="$1" layoutId="$2" size="$3"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" flex_id="$(jo id="$layoutId")" item_id="$(jo id="$childId")" proportion=0 fixed_size="$size" focus=false)
    @ "$client" call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: "$json"
}

__Yutani__Session__addChild_to_fixedSize_focus_() {
  local childId="$1"
  local layoutId="$2"
  local size="$3"
  local shouldFocus="$4"
    local sid client json childId="$1" layoutId="$2" size="$3" shouldFocus="$4"
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"
    json=$(jo session_id="$(jo id="$sid")" flex_id="$(jo id="$layoutId")" item_id="$(jo id="$childId")" proportion=0 fixed_size="$size" focus="$shouldFocus")
    @ "$client" call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: "$json"
}

declare -g __Yutani__Session__streamEventsWithBlock___direct=1
__Yutani__Session__streamEventsWithBlock_() {
  local block="$1"
    local sid client filter_json
    sid="$(_ivar sessionId)"
    client="$(_ivar grpcClient)"

    # Build filter JSON for Subscribe request
    filter_json=$(jo session_id="$(jo id="$sid")" \
    filter="$(jo receive_key_events=true receive_mouse_events=true \
        receive_resize_events=true receive_focus_events=true receive_widget_events=true)")

    # Use native streaming - blocks until stream ends, calls block for each message
    @ "$client" serverStream: 'industries.loosh.yutani.v1.EventService/Subscribe' \
        with: "$filter_json" \
        handler: "$1"
}

declare -g __Yutani__Session__runEventLoopWithDispatcher___direct=1
__Yutani__Session__runEventLoopWithDispatcher_() {
  local dispatcher="$1"
    local dispatcher="$1" handlerBlock

    # Create a block that converts JSON to Event and dispatches it
    handlerBlock=$(@ Block new: "
    local json=\"\$1\"
    @ \"$dispatcher\" dispatchJson: \"\$json\"
    ")

    # Start streaming - this blocks until stream ends/errors
    @ "$_RECEIVER" streamEventsWithBlock: "$handlerBlock"
}

__Yutani__Session__startEventStream() {
    local sid filter_json host evt_coproc cmd
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"

    # Build filter JSON
    filter_json=$(jo session_id="$(jo id="$sid")" \
    filter="$(jo receive_key_events=true receive_mouse_events=true \
        receive_resize_events=true receive_focus_events=true receive_widget_events=true)")

    # Build the grpcurl command - pipe through jq -c to get compact single-line JSON
    # Use --unbuffered to prevent jq from buffering output
    cmd="grpcurl -plaintext -d '$filter_json' $host industries.loosh.yutani.v1.EventService/Subscribe | jq --unbuffered -c ."

    # Create and start coproc
    evt_coproc=$(@ Coproc for: "$cmd")
    @ "$evt_coproc" startReadOnly

    _ivar_set eventCoproc "$evt_coproc"
}

__Yutani__Session__stopEventStream() {
    local evt_coproc
    evt_coproc="$(_ivar eventCoproc)"

    if [[ -n "$evt_coproc" ]]; then
        @ "$evt_coproc" terminate
        _ivar_set eventCoproc ""
    fi
}

__Yutani__Session__onEventDo_() {
  local handler="$1"
    local evt_coproc handler="$1"
    evt_coproc="$(_ivar eventCoproc)"

    # Start stream if not already running
    if [[ -z "$evt_coproc" ]]; then
        @ "$_RECEIVER" startEventStream
        evt_coproc="$(_ivar eventCoproc)"
    fi

    # Read lines continuously, calling handler for each
    @ "$evt_coproc" readLinesDo: "$handler"
}

__Yutani__Session__nextEvent() {
    local evt_coproc line
    evt_coproc="$(_ivar eventCoproc)"

    # Start stream if not already running
    if [[ -z "$evt_coproc" ]]; then
        @ "$_RECEIVER" startEventStream
        evt_coproc="$(_ivar eventCoproc)"
    fi

    # Read next line (blocks until event arrives)
    line=$(@ "$evt_coproc" readLine)
    echo "$line"
}

__Yutani__Session___setHost_() {
  local v="$1"
  _ivar_set host "$v"
}

__Yutani__Session___setSessionId_() {
  local v="$1"
  _ivar_set sessionId "$v"
}

__Yutani__Session___setGrpcClient_() {
  local v="$1"
  _ivar_set grpcClient "$v"
}
