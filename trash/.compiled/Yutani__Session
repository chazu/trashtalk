#!/usr/bin/env bash
# Generated by Trashtalk Compiler (jq) - DO NOT EDIT
# Source: Session.trash
# Generated: 2026-01-06T01:25:39

__Yutani__Session__superclass="Object"
__Yutani__Session__instanceVars="sessionId: host:localhost:7755 eventCoproc:"
__Yutani__Session__classInstanceVars=""
__Yutani__Session__traits=""
__Yutani__Session__sourceHash="5247b098aebafe7ac298dc6d8fba612f7758a4b40ab8f912317feb657fd6da5a"
__Yutani__Session__package="Yutani"
__Yutani__Session__qualifiedName="Yutani::Session"

__Yutani__Session__source() {
  cat <<'__TRASHTALK_SOURCE_EOF__'
package: Yutani

Session subclass: Object
  instanceVars: sessionId:'' host:'localhost:7755' eventCoproc:''

  rawClassMethod: connectTo: host [
    local host="$1"
    local session response sid
    session=$(@ Yutani::Session new)
    @ "$session" setHost: "$host"
    response=$(@ "$session" createSession)
    sid=$(echo "$response" | jq -r '.sessionId.id')
    @ "$session" setSessionId: "$sid"
    echo "$session"
  ]

  rawClassMethod: connect [
    @ Yutani::Session connectTo: 'localhost:7755'
  ]

  method: setHost: h [
    _ivar_set host "$h"
  ]

  method: setSessionId: sid [
    _ivar_set sessionId "$sid"
  ]

  method: sessionId [
    _ivar sessionId
  ]

  method: host [
    _ivar host
  ]

  method: disconnect [
    @ self destroySession.
    @ self stopEventStream
  ]

  rawMethod: createSession [
    local host
    host="$(_ivar host)"
    grpcurl -plaintext -d '{"client_name": "trashtalk"}' "$host" \
      "industries.loosh.yutani.v1.SessionService/CreateSession" 2>&1
  ]

  rawMethod: destroySession [
    local sid host json
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.SessionService/DestroySession" 2>&1
  ]

  rawMethod: ping [
    local ts host json
    ts=$(date +%s)
    host="$(_ivar host)"
    json=$(jo timestamp="$ts")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.SessionService/Ping" 2>&1
  ]

  rawMethod: serverInfo [
    local host
    host="$(_ivar host)"
    grpcurl -plaintext -d '{}' "$host" \
      "industries.loosh.yutani.v1.SessionService/GetServerInfo" 2>&1
  ]

  rawMethod: screenSize [
    local sid host json
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.ScreenService/GetSize" 2>&1
  ]

  rawMethod: clearScreen [
    local sid host json
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.ScreenService/Clear" 2>&1
  ]

  rawMethod: sync [
    local sid host json
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.ScreenService/Sync" 2>&1
  ]

  rawMethod: createList: title [
    local sid host json response title="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_LIST" properties="$(jo border=true title="$title")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: createTextView: title [
    local sid host json response title="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_TEXT_VIEW" \
      properties="$(jo border=true title="$title" \
        text_view="$(jo word_wrap=true dynamic_colors=true)")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: createTextViewWithText: title text: text [
    local sid host json response title="$1" text="$2"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_TEXT_VIEW" \
      properties="$(jo border=true title="$title" \
        text_view="$(jo -- -s text="$text" word_wrap=true dynamic_colors=true)")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: setText: text on: widgetId [
    local sid host json text="$1" widgetId="$2"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")" \
      properties="$(jo text_view="$(jo -- -s text="$text")")")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/SetProperties" 2>&1
  ]

  rawMethod: addItem: mainText to: listId [
    local sid host json mainText="$1" listId="$2"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$listId")" main_text="$mainText")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.ListService/AddItem" 2>&1
  ]

  rawMethod: addItem: mainText secondary: secondaryText to: listId [
    local sid host json mainText="$1" secondaryText="$2" listId="$3"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$listId")" \
      main_text="$mainText" secondary_text="$secondaryText")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.ListService/AddItem" 2>&1
  ]

  rawMethod: clearList: listId [
    local sid host json listId="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$listId")")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.ListService/Clear" 2>&1
  ]

  rawMethod: setRoot: widgetId [
    local sid host json widgetId="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/SetRoot" 2>&1
  ]

  rawMethod: listWidgets [
    local sid host json
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/ListWidgets" 2>&1
  ]

  rawMethod: deleteWidget: widgetId [
    local sid host json widgetId="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/DeleteWidget" 2>&1
  ]

  rawMethod: createHorizontalLayout [
    local sid host json response
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    # FLEX_COLUMN = items side by side (horizontal)
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_FLEX" \
      properties="$(jo flex="$(jo direction="FLEX_COLUMN")")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: createVerticalLayout [
    local sid host json response
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    # FLEX_ROW = items stacked vertically (top to bottom)
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_FLEX" \
      properties="$(jo flex="$(jo direction="FLEX_ROW")")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: addChild: childId to: layoutId [
    local sid host json childId="$1" layoutId="$2"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" flex_id="$(jo id="$layoutId")" item_id="$(jo id="$childId")" proportion=1 fixed_size=0 focus=false)
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.LayoutService/FlexAddItem" 2>&1
  ]

  rawMethod: addChild: childId to: layoutId fixedSize: size [
    local sid host json childId="$1" layoutId="$2" size="$3"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" flex_id="$(jo id="$layoutId")" item_id="$(jo id="$childId")" proportion=0 fixed_size="$size" focus=false)
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.LayoutService/FlexAddItem" 2>&1
  ]

  rawMethod: addChild: childId to: layoutId fixedSize: size focus: shouldFocus [
    local sid host json childId="$1" layoutId="$2" size="$3" shouldFocus="$4"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" flex_id="$(jo id="$layoutId")" item_id="$(jo id="$childId")" proportion=0 fixed_size="$size" focus="$shouldFocus")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.LayoutService/FlexAddItem" 2>&1
  ]

  rawMethod: createInputField: label [
    local sid host json response label="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_INPUT_FIELD" \
      properties="$(jo border=true input_field="$(jo -- -s label="$label" -s placeholder="" -s text="")")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: createInputFieldWithPlaceholder: label placeholder: placeholder [
    local sid host json response label="$1" placeholder="$2"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_INPUT_FIELD" \
      properties="$(jo border=true input_field="$(jo -- -s label="$label" -s placeholder="$placeholder" -s text="")")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
  ]

  rawMethod: setInputText: text on: widgetId [
    local sid host json text="$1" widgetId="$2"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")" \
      properties="$(jo input_field="$(jo -- -s text="$text")")")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/SetProperties" 2>&1
  ]

  rawMethod: getInputText: widgetId [
    local sid host json response widgetId="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/GetProperties" 2>&1)
    # Try both camelCase and snake_case field names
    echo "$response" | jq -r '.properties.inputField.text // .properties.input_field.text // ""'
  ]

  rawMethod: focusWidget: widgetId [
    local sid host json widgetId="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    grpcurl -plaintext -d "$json" "$host" \
      "industries.loosh.yutani.v1.WidgetService/SetFocus" 2>&1
  ]

  rawMethod: startEventStream [
    local sid filter_json host evt_coproc cmd
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"

    # Build filter JSON
    filter_json=$(jo session_id="$(jo id="$sid")" \
      filter="$(jo receive_key_events=true receive_mouse_events=true \
        receive_resize_events=true receive_focus_events=true receive_widget_events=true)")

    # Build the grpcurl command - pipe through jq -c to get compact single-line JSON
    # Use --unbuffered to prevent jq from buffering output
    cmd="grpcurl -plaintext -d '$filter_json' $host industries.loosh.yutani.v1.EventService/Subscribe | jq --unbuffered -c ."

    # Create and start coproc
    evt_coproc=$(@ Coproc for: "$cmd")
    @ "$evt_coproc" startReadOnly

    _ivar_set eventCoproc "$evt_coproc"
  ]

  rawMethod: stopEventStream [
    local evt_coproc
    evt_coproc="$(_ivar eventCoproc)"

    if [[ -n "$evt_coproc" ]]; then
      @ "$evt_coproc" terminate
      _ivar_set eventCoproc ""
    fi
  ]

  # Process events with a handler. Handler can read $__COPROC_LINE.
  # Usage: @ $session onEventDo: '@ $obj handleEvent'
  rawMethod: onEventDo: handler [
    local evt_coproc handler="$1"
    evt_coproc="$(_ivar eventCoproc)"

    # Start stream if not already running
    if [[ -z "$evt_coproc" ]]; then
      @ "$_RECEIVER" startEventStream
      evt_coproc="$(_ivar eventCoproc)"
    fi

    # Read lines continuously, calling handler for each
    @ "$evt_coproc" readLinesDo: "$handler"
  ]

  rawMethod: nextEvent [
    local evt_coproc line
    evt_coproc="$(_ivar eventCoproc)"

    # Start stream if not already running
    if [[ -z "$evt_coproc" ]]; then
      @ "$_RECEIVER" startEventStream
      evt_coproc="$(_ivar eventCoproc)"
    fi

    # Read next line (blocks until event arrives)
    line=$(@ "$evt_coproc" readLine)
    echo "$line"
  ]
__TRASHTALK_SOURCE_EOF__
}

__Yutani__Session__sessionId() {
  echo "$(_ivar sessionId)"; return
}

__Yutani__Session__sessionId_() {
  _ivar_set sessionId "$1"
}

__Yutani__Session__getSessionId() {
  echo "$(_ivar sessionId)"; return
}

__Yutani__Session__setSessionId_() {
  _ivar_set sessionId "$1"
}
__Yutani__Session__host() {
  echo "$(_ivar host)"; return
}

__Yutani__Session__host_() {
  _ivar_set host "$1"
}

__Yutani__Session__getHost() {
  echo "$(_ivar host)"; return
}

__Yutani__Session__setHost_() {
  _ivar_set host "$1"
}
__Yutani__Session__eventCoproc() {
  echo "$(_ivar eventCoproc)"; return
}

__Yutani__Session__eventCoproc_() {
  _ivar_set eventCoproc "$1"
}

__Yutani__Session__getEventCoproc() {
  echo "$(_ivar eventCoproc)"; return
}

__Yutani__Session__setEventCoproc_() {
  _ivar_set eventCoproc "$1"
}

__Yutani__Session__class__connectTo_() {
  local host="$1"
    local host="$1"
    local session response sid
    session=$(@ Yutani::Session new)
    @ "$session" setHost: "$host"
    response=$(@ "$session" createSession)
    sid=$(echo "$response" | jq -r '.sessionId.id')
    @ "$session" setSessionId: "$sid"
    echo "$session"
}

__Yutani__Session__class__connect() {
    @ Yutani :: Session connectTo: 'localhost:7755'
}

__Yutani__Session__setHost_() {
  local h="$1"
  _ivar_set host "$h"
}

__Yutani__Session__setSessionId_() {
  local sid="$1"
  _ivar_set sessionId "$sid"
}

__Yutani__Session__sessionId() {
  _ivar sessionId
}

__Yutani__Session__host() {
  _ivar host
}

__Yutani__Session__disconnect() {
  @ "$_RECEIVER" destroySession
  @ "$_RECEIVER" stopEventStream
}

__Yutani__Session__createSession() {
    local host
    host="$(_ivar host)"
    grpcurl -plaintext -d '{"client_name": "trashtalk"}' "$host" \
        "industries.loosh.yutani.v1.SessionService/CreateSession" 2>&1
}

__Yutani__Session__destroySession() {
    local sid host json
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.SessionService/DestroySession" 2>&1
}

__Yutani__Session__ping() {
    local ts host json
    ts=$(date +%s)
    host="$(_ivar host)"
    json=$(jo timestamp="$ts")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.SessionService/Ping" 2>&1
}

__Yutani__Session__serverInfo() {
    local host
    host="$(_ivar host)"
    grpcurl -plaintext -d '{}' "$host" \
        "industries.loosh.yutani.v1.SessionService/GetServerInfo" 2>&1
}

__Yutani__Session__screenSize() {
    local sid host json
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.ScreenService/GetSize" 2>&1
}

__Yutani__Session__clearScreen() {
    local sid host json
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.ScreenService/Clear" 2>&1
}

__Yutani__Session__sync() {
    local sid host json
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.ScreenService/Sync" 2>&1
}

__Yutani__Session__createList_() {
  local title="$1"
    local sid host json response title="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_LIST" properties="$(jo border=true title="$title")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__createTextView_() {
  local title="$1"
    local sid host json response title="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_TEXT_VIEW" \
        properties="$(jo border=true title="$title" \
        text_view="$(jo word_wrap=true dynamic_colors=true)")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__createTextViewWithText_text_() {
  local title="$1"
  local text="$2"
    local sid host json response title="$1" text="$2"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_TEXT_VIEW" \
        properties="$(jo border=true title="$title" \
        text_view="$(jo -- -s text="$text" word_wrap=true dynamic_colors=true)")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__setText_on_() {
  local text="$1"
  local widgetId="$2"
    local sid host json text="$1" widgetId="$2"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")" \
        properties="$(jo text_view="$(jo -- -s text="$text")")")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/SetProperties" 2>&1
}

__Yutani__Session__addItem_to_() {
  local mainText="$1"
  local listId="$2"
    local sid host json mainText="$1" listId="$2"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$listId")" main_text="$mainText")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.ListService/AddItem" 2>&1
}

__Yutani__Session__addItem_secondary_to_() {
  local mainText="$1"
  local secondaryText="$2"
  local listId="$3"
    local sid host json mainText="$1" secondaryText="$2" listId="$3"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$listId")" \
        main_text="$mainText" secondary_text="$secondaryText")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.ListService/AddItem" 2>&1
}

__Yutani__Session__clearList_() {
  local listId="$1"
    local sid host json listId="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$listId")")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.ListService/Clear" 2>&1
}

__Yutani__Session__setRoot_() {
  local widgetId="$1"
    local sid host json widgetId="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/SetRoot" 2>&1
}

__Yutani__Session__listWidgets() {
    local sid host json
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/ListWidgets" 2>&1
}

__Yutani__Session__deleteWidget_() {
  local widgetId="$1"
    local sid host json widgetId="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/DeleteWidget" 2>&1
}

__Yutani__Session__createHorizontalLayout() {
    local sid host json response
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    # FLEX_COLUMN= items side by side (horizontal)
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_FLEX" \
        properties="$(jo flex="$(jo direction="FLEX_COLUMN")")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__createVerticalLayout() {
    local sid host json response
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    # FLEX_ROW= items stacked vertically (top to bottom)
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_FLEX" \
        properties="$(jo flex="$(jo direction="FLEX_ROW")")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__addChild_to_() {
  local childId="$1"
  local layoutId="$2"
    local sid host json childId="$1" layoutId="$2"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" flex_id="$(jo id="$layoutId")" item_id="$(jo id="$childId")" proportion=1 fixed_size=0 focus=false)
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.LayoutService/FlexAddItem" 2>&1
}

__Yutani__Session__addChild_to_fixedSize_() {
  local childId="$1"
  local layoutId="$2"
  local size="$3"
    local sid host json childId="$1" layoutId="$2" size="$3"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" flex_id="$(jo id="$layoutId")" item_id="$(jo id="$childId")" proportion=0 fixed_size="$size" focus=false)
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.LayoutService/FlexAddItem" 2>&1
}

__Yutani__Session__addChild_to_fixedSize_focus_() {
  local childId="$1"
  local layoutId="$2"
  local size="$3"
  local shouldFocus="$4"
    local sid host json childId="$1" layoutId="$2" size="$3" shouldFocus="$4"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" flex_id="$(jo id="$layoutId")" item_id="$(jo id="$childId")" proportion=0 fixed_size="$size" focus="$shouldFocus")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.LayoutService/FlexAddItem" 2>&1
}

__Yutani__Session__createInputField_() {
  local label="$1"
    local sid host json response label="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_INPUT_FIELD" \
        properties="$(jo border=true input_field="$(jo -- -s label="$label" -s placeholder="" -s text="")")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__createInputFieldWithPlaceholder_placeholder_() {
  local label="$1"
  local placeholder="$2"
    local sid host json response label="$1" placeholder="$2"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" type="WIDGET_INPUT_FIELD" \
        properties="$(jo border=true input_field="$(jo -- -s label="$label" -s placeholder="$placeholder" -s text="")")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/CreateWidget" 2>&1)
    echo "$response" | jq -r '.widgetId.id'
}

__Yutani__Session__setInputText_on_() {
  local text="$1"
  local widgetId="$2"
    local sid host json text="$1" widgetId="$2"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")" \
        properties="$(jo input_field="$(jo -- -s text="$text")")")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/SetProperties" 2>&1
}

__Yutani__Session__getInputText_() {
  local widgetId="$1"
    local sid host json response widgetId="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    response=$(grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/GetProperties" 2>&1)
    # Try both camelCase and snake_case field names
    echo "$response" | jq -r '.properties.inputField.text // .properties.input_field.text // ""'
}

__Yutani__Session__focusWidget_() {
  local widgetId="$1"
    local sid host json widgetId="$1"
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"
    json=$(jo session_id="$(jo id="$sid")" widget_id="$(jo id="$widgetId")")
    grpcurl -plaintext -d "$json" "$host" \
        "industries.loosh.yutani.v1.WidgetService/SetFocus" 2>&1
}

__Yutani__Session__startEventStream() {
    local sid filter_json host evt_coproc cmd
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"

    # Build filter JSON
    filter_json=$(jo session_id="$(jo id="$sid")" \
    filter="$(jo receive_key_events=true receive_mouse_events=true \
        receive_resize_events=true receive_focus_events=true receive_widget_events=true)")

    # Build the grpcurl command - pipe through jq -c to get compact single-line JSON
    # Use --unbuffered to prevent jq from buffering output
    cmd="grpcurl -plaintext -d '$filter_json' $host industries.loosh.yutani.v1.EventService/Subscribe | jq --unbuffered -c ."

    # Create and start coproc
    evt_coproc=$(@ Coproc for: "$cmd")
    @ "$evt_coproc" startReadOnly

    _ivar_set eventCoproc "$evt_coproc"
}

__Yutani__Session__stopEventStream() {
    local evt_coproc
    evt_coproc="$(_ivar eventCoproc)"

    if [[ -n "$evt_coproc" ]]; then
        @ "$evt_coproc" terminate
        _ivar_set eventCoproc ""
    fi
}

__Yutani__Session__onEventDo_() {
  local handler="$1"
    local evt_coproc handler="$1"
    evt_coproc="$(_ivar eventCoproc)"

    # Start stream if not already running
    if [[ -z "$evt_coproc" ]]; then
        @ "$_RECEIVER" startEventStream
        evt_coproc="$(_ivar eventCoproc)"
    fi

    # Read lines continuously, calling handler for each
    @ "$evt_coproc" readLinesDo: "$handler"
}

__Yutani__Session__nextEvent() {
    local evt_coproc line
    evt_coproc="$(_ivar eventCoproc)"

    # Start stream if not already running
    if [[ -z "$evt_coproc" ]]; then
        @ "$_RECEIVER" startEventStream
        evt_coproc="$(_ivar eventCoproc)"
    fi

    # Read next line (blocks until event arrives)
    line=$(@ "$evt_coproc" readLine)
    echo "$line"
}
