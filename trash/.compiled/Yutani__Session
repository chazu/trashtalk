#!/usr/bin/env bash
# Generated by Trashtalk Compiler (procyon) - DO NOT EDIT
# Source: Session.trash
# Generated: 2026-01-17T13:09:47

__Yutani__Session__superclass="Object"
__Yutani__Session__instanceVars="sessionId: host:localhost:7755 eventCoproc: grpcClient: eventDispatcher:"
__Yutani__Session__classInstanceVars=""
__Yutani__Session__traits=""
__Yutani__Session__sourceHash="bf768eb494d2ca6c01eb0f15f8a48a8f6442490a2bf59bac37e2e21c6e071df2"

__Yutani__Session__source() {
  cat <<'__TRASHTALK_SOURCE_EOF__'
package: Yutani

# Yutani Session - manages connection to Yutani UI server
# Refactored to use GrpcClient for connection pooling and native Procyon support

Session subclass: Object
  instanceVars: sessionId:'' host:'localhost:7755' eventCoproc:'' grpcClient:'' eventDispatcher:''

  # ============================================================================
  # Factory Methods
  # ============================================================================

  classMethod: connectTo: theHost [
    | client session builder json response sid _ |
    # Create GrpcClient with pooling enabled
    client := @ GrpcClient connectTo: theHost.
    _ := @ client enablePooling.
    # Create session instance
    session := @ Yutani::Session new.
    _ := @ session setHost: theHost.
    _ := @ session setGrpcClient: client.
    # Create session on server
    builder := @ Json object.
    _ := @ builder at: 'client_name' put: 'trashtalk'.
    json := @ builder build.
    response := @ client call: 'industries.loosh.yutani.v1.SessionService/CreateSession' with: json.
    sid := @ String jsonPath: 'sessionId.id' from: response.
    _ := @ session setSessionId: sid.
    ^ session
  ]

  classMethod: connect [
    @ Yutani::Session connectTo: 'localhost:7755'
  ]

  # ============================================================================
  # Accessors
  # ============================================================================

  method: getSessionId [ ^ sessionId ]
  method: getHost [ ^ host ]
  method: getGrpcClient [ ^ grpcClient ]

  # Setters (used by factory methods)
  method: setSessionId: sid [ sessionId := sid ]
  method: setHost: h [ host := h ]
  method: setGrpcClient: client [ grpcClient := client ]

  # ============================================================================
  # Session Lifecycle
  # ============================================================================

  method: disconnect [
    @ self destroySession.
    @ self stopEventStream
  ]

  method: destroySession [
    | json |
    json := @ Json sessionId: sessionId.
    @ grpcClient call: 'industries.loosh.yutani.v1.SessionService/DestroySession' with: json
  ]

  method: ping [
    | ts builder json _ |
    ts := @ Time now.
    builder := @ Json object.
    _ := @ builder at: 'timestamp' putNumber: ts.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.SessionService/Ping' with: json
  ]

  method: serverInfo [
    @ grpcClient call: 'industries.loosh.yutani.v1.SessionService/GetServerInfo' with: '{}'
  ]

  # ============================================================================
  # Screen Operations
  # ============================================================================

  method: screenSize [
    | json |
    json := @ Json sessionId: sessionId.
    @ grpcClient call: 'industries.loosh.yutani.v1.ScreenService/GetSize' with: json
  ]

  method: clearScreen [
    | json |
    json := @ Json sessionId: sessionId.
    @ grpcClient call: 'industries.loosh.yutani.v1.ScreenService/Clear' with: json
  ]

  method: sync [
    | json |
    json := @ Json sessionId: sessionId.
    @ grpcClient call: 'industries.loosh.yutani.v1.ScreenService/Sync' with: json
  ]

  # ============================================================================
  # Widget Creation
  # ============================================================================

  method: createList: title [
    | sidBuilder propsBuilder builder sidJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'border' putBool: 'true'.
    _ := @ propsBuilder at: 'title' put: title.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_LIST'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ @ String jsonPath: 'widgetId.id' from: response
  ]

  method: createTextView: title [
    | sidBuilder tvBuilder propsBuilder builder sidJson tvJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    tvBuilder := @ Json object.
    _ := @ tvBuilder at: 'word_wrap' putBool: 'true'.
    _ := @ tvBuilder at: 'dynamic_colors' putBool: 'true'.
    tvJson := @ tvBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'border' putBool: 'true'.
    _ := @ propsBuilder at: 'title' put: title.
    _ := @ propsBuilder at: 'text_view' putJson: tvJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_TEXT_VIEW'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ @ String jsonPath: 'widgetId.id' from: response
  ]

  method: createTextViewWithText: title text: text [
    | sidBuilder tvBuilder propsBuilder builder sidJson tvJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    tvBuilder := @ Json object.
    _ := @ tvBuilder at: 'text' put: text.
    _ := @ tvBuilder at: 'word_wrap' putBool: 'true'.
    _ := @ tvBuilder at: 'dynamic_colors' putBool: 'true'.
    tvJson := @ tvBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'border' putBool: 'true'.
    _ := @ propsBuilder at: 'title' put: title.
    _ := @ propsBuilder at: 'text_view' putJson: tvJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_TEXT_VIEW'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ @ String jsonPath: 'widgetId.id' from: response
  ]

  method: createInputField: label [
    | sidBuilder ifBuilder propsBuilder builder sidJson ifJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    ifBuilder := @ Json object.
    _ := @ ifBuilder at: 'label' put: label.
    _ := @ ifBuilder at: 'placeholder' put: ''.
    _ := @ ifBuilder at: 'text' put: ''.
    ifJson := @ ifBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'border' putBool: 'true'.
    _ := @ propsBuilder at: 'input_field' putJson: ifJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_INPUT_FIELD'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ @ String jsonPath: 'widgetId.id' from: response
  ]

  method: createInputFieldWithPlaceholder: label placeholder: placeholder [
    | sidBuilder ifBuilder propsBuilder builder sidJson ifJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    ifBuilder := @ Json object.
    _ := @ ifBuilder at: 'label' put: label.
    _ := @ ifBuilder at: 'placeholder' put: placeholder.
    _ := @ ifBuilder at: 'text' put: ''.
    ifJson := @ ifBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'border' putBool: 'true'.
    _ := @ propsBuilder at: 'input_field' putJson: ifJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_INPUT_FIELD'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ @ String jsonPath: 'widgetId.id' from: response
  ]

  # FLEX_COLUMN = items side by side (horizontal)
  method: createHorizontalLayout [
    | sidBuilder flexBuilder propsBuilder builder sidJson flexJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    flexBuilder := @ Json object.
    _ := @ flexBuilder at: 'direction' put: 'FLEX_COLUMN'.
    flexJson := @ flexBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'flex' putJson: flexJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_FLEX'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ @ String jsonPath: 'widgetId.id' from: response
  ]

  # FLEX_ROW = items stacked vertically (top to bottom)
  method: createVerticalLayout [
    | sidBuilder flexBuilder propsBuilder builder sidJson flexJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    flexBuilder := @ Json object.
    _ := @ flexBuilder at: 'direction' put: 'FLEX_ROW'.
    flexJson := @ flexBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'flex' putJson: flexJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_FLEX'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ @ String jsonPath: 'widgetId.id' from: response
  ]

  # ============================================================================
  # Widget Operations
  # ============================================================================

  method: setText: text on: wid [
    | sidBuilder widBuilder tvBuilder propsBuilder builder sidJson widJson tvJson propsJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    widBuilder := @ Json object.
    _ := @ widBuilder at: 'id' put: wid.
    widJson := @ widBuilder build.
    tvBuilder := @ Json object.
    _ := @ tvBuilder at: 'text' put: text.
    tvJson := @ tvBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'text_view' putJson: tvJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'widget_id' putJson: widJson.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/SetProperties' with: json
  ]

  method: setInputText: text on: wid [
    | sidBuilder widBuilder ifBuilder propsBuilder builder sidJson widJson ifJson propsJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    widBuilder := @ Json object.
    _ := @ widBuilder at: 'id' put: wid.
    widJson := @ widBuilder build.
    ifBuilder := @ Json object.
    _ := @ ifBuilder at: 'text' put: text.
    ifJson := @ ifBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'input_field' putJson: ifJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'widget_id' putJson: widJson.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/SetProperties' with: json
  ]

  method: getInputText: wid [
    | json response result |
    json := @ Json sessionId: sessionId widgetId: wid.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/GetProperties' with: json.
    # Try camelCase first, then snake_case
    result := @ String jsonPath: 'properties.inputField.text' from: response.
    result isEmpty ifTrue: [
      result := @ String jsonPath: 'properties.input_field.text' from: response
    ].
    ^ result
  ]

  method: focusWidget: wid [
    | json |
    json := @ Json sessionId: sessionId widgetId: wid.
    @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/SetFocus' with: json
  ]

  method: setRoot: wid [
    | json |
    json := @ Json sessionId: sessionId widgetId: wid.
    @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/SetRoot' with: json
  ]

  method: listWidgets [
    | json |
    json := @ Json sessionId: sessionId.
    @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/ListWidgets' with: json
  ]

  method: deleteWidget: wid [
    | json |
    json := @ Json sessionId: sessionId widgetId: wid.
    @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/DeleteWidget' with: json
  ]

  # ============================================================================
  # List Operations
  # ============================================================================

  method: addItem: mainText to: listId [
    | sidBuilder widBuilder builder sidJson widJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    widBuilder := @ Json object.
    _ := @ widBuilder at: 'id' put: listId.
    widJson := @ widBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'widget_id' putJson: widJson.
    _ := @ builder at: 'main_text' put: mainText.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.ListService/AddItem' with: json
  ]

  method: addItem: mainText secondary: secondaryText to: listId [
    | sidBuilder widBuilder builder sidJson widJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    widBuilder := @ Json object.
    _ := @ widBuilder at: 'id' put: listId.
    widJson := @ widBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'widget_id' putJson: widJson.
    _ := @ builder at: 'main_text' put: mainText.
    _ := @ builder at: 'secondary_text' put: secondaryText.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.ListService/AddItem' with: json
  ]

  method: clearList: listId [
    | json |
    json := @ Json sessionId: sessionId widgetId: listId.
    @ grpcClient call: 'industries.loosh.yutani.v1.ListService/Clear' with: json
  ]

  # ============================================================================
  # Layout Operations
  # ============================================================================

  method: addChild: childId to: layoutId [
    | sidBuilder flexBuilder itemBuilder builder sidJson flexJson itemJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    flexBuilder := @ Json object.
    _ := @ flexBuilder at: 'id' put: layoutId.
    flexJson := @ flexBuilder build.
    itemBuilder := @ Json object.
    _ := @ itemBuilder at: 'id' put: childId.
    itemJson := @ itemBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'flex_id' putJson: flexJson.
    _ := @ builder at: 'item_id' putJson: itemJson.
    _ := @ builder at: 'proportion' putNumber: '1'.
    _ := @ builder at: 'fixed_size' putNumber: '0'.
    _ := @ builder at: 'focus' putBool: 'false'.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: json
  ]

  method: addChild: childId to: layoutId fixedSize: size [
    | sidBuilder flexBuilder itemBuilder builder sidJson flexJson itemJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    flexBuilder := @ Json object.
    _ := @ flexBuilder at: 'id' put: layoutId.
    flexJson := @ flexBuilder build.
    itemBuilder := @ Json object.
    _ := @ itemBuilder at: 'id' put: childId.
    itemJson := @ itemBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'flex_id' putJson: flexJson.
    _ := @ builder at: 'item_id' putJson: itemJson.
    _ := @ builder at: 'proportion' putNumber: '0'.
    _ := @ builder at: 'fixed_size' putNumber: size.
    _ := @ builder at: 'focus' putBool: 'false'.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: json
  ]

  method: addChild: childId to: layoutId fixedSize: size focus: shouldFocus [
    | sidBuilder flexBuilder itemBuilder builder sidJson flexJson itemJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    flexBuilder := @ Json object.
    _ := @ flexBuilder at: 'id' put: layoutId.
    flexJson := @ flexBuilder build.
    itemBuilder := @ Json object.
    _ := @ itemBuilder at: 'id' put: childId.
    itemJson := @ itemBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'flex_id' putJson: flexJson.
    _ := @ builder at: 'item_id' putJson: itemJson.
    _ := @ builder at: 'proportion' putNumber: '0'.
    _ := @ builder at: 'fixed_size' putNumber: size.
    _ := @ builder at: 'focus' putBool: shouldFocus.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: json
  ]

  # ============================================================================
  # Event Streaming - Native (preferred) or Coproc (fallback)
  # ============================================================================

  # Native streaming using GrpcClient.serverStream (requires native daemon)
  # This is the preferred method - uses persistent gRPC connection, no subprocess
  # The block receives JSON event data for each streamed message
  method: streamEventsWithBlock: block [
    | sidBuilder filterBuilder builder sidJson filterJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    filterBuilder := @ Json object.
    _ := @ filterBuilder at: 'receive_key_events' putBool: 'true'.
    _ := @ filterBuilder at: 'receive_mouse_events' putBool: 'true'.
    _ := @ filterBuilder at: 'receive_resize_events' putBool: 'true'.
    _ := @ filterBuilder at: 'receive_focus_events' putBool: 'true'.
    _ := @ filterBuilder at: 'receive_widget_events' putBool: 'true'.
    filterJson := @ filterBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'filter' putJson: filterJson.
    json := @ builder build.
    @ grpcClient serverStream: 'industries.loosh.yutani.v1.EventService/Subscribe' with: json handler: block
  ]

  # High-level streaming with EventDispatcher integration
  # Creates Event objects and dispatches them through the provided dispatcher
  # Usage: @ $session runEventLoopWithDispatcher: $dispatcher
  method: runEventLoopWithDispatcher: aDispatcher [
    # Store dispatcher so valueWith: can access it
    eventDispatcher := aDispatcher.
    # Pass self as handler - Session.valueWith: will dispatch events
    @ self streamEventsWithBlock: self
  ]

  # Called by streamEventsWithBlock: for each JSON line
  # Converts to Event and dispatches through stored eventDispatcher
  method: valueWith: json [
    (eventDispatcher notEmpty) ifTrue: [
      @ eventDispatcher dispatchJson: json
    ]
  ]

  # ============================================================================
  # Fallback: Coproc-based streaming (for when native daemon unavailable)
  # ============================================================================

  # Fallback coproc-based event streaming (for when native daemon unavailable)
  # Writes JSON to temp file to avoid shell quoting issues
  method: startEventStream [
    | sidBuilder filterBuilder builder sidJson filterJson json tmpFile cmd cmdPart1 cmdPart2 ec f _ |
    # Build filter JSON using Json builder
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    filterBuilder := @ Json object.
    _ := @ filterBuilder at: 'receive_key_events' putBool: 'true'.
    _ := @ filterBuilder at: 'receive_mouse_events' putBool: 'true'.
    _ := @ filterBuilder at: 'receive_resize_events' putBool: 'true'.
    _ := @ filterBuilder at: 'receive_focus_events' putBool: 'true'.
    _ := @ filterBuilder at: 'receive_widget_events' putBool: 'true'.
    filterJson := @ filterBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'filter' putJson: filterJson.
    json := @ builder build.
    # Write JSON to temp file to avoid quoting issues in command string
    tmpFile := '/tmp/yutani_subscribe_filter.json'.
    f := @ File for: tmpFile.
    _ := @ f write: json.
    # Build grpcurl command: grpcurl -plaintext -d @FILE HOST SERVICE | jq -c .
    cmdPart1 := @ String concat: 'grpcurl -plaintext -d @' with: tmpFile with: ' '.
    cmdPart2 := @ String concat: host with: ' industries.loosh.yutani.v1.EventService/Subscribe | jq --unbuffered -c .'.
    cmd := @ String concat: cmdPart1 with: cmdPart2.
    # Create and start coproc
    ec := @ Coproc for: cmd.
    _ := @ ec startReadOnly.
    eventCoproc := ec
  ]

  method: stopEventStream [
    | ec |
    ec := eventCoproc.
    (ec notEmpty) ifTrue: [
      @ ec terminate.
      eventCoproc := ''
    ]
  ]

  # Process events with a handler (coproc mode). Handler can read $__COPROC_LINE.
  # Usage: @ $session onEventDo: '@ $obj handleEvent'
  method: onEventDo: handler [
    | ec |
    ec := eventCoproc.
    (ec isEmpty) ifTrue: [
      @ self startEventStream.
      ec := eventCoproc
    ].
    @ ec readLinesDo: handler
  ]

  method: nextEvent [
    | ec line |
    ec := eventCoproc.
    (ec isEmpty) ifTrue: [
      @ self startEventStream.
      ec := eventCoproc
    ].
    line := @ ec readLine.
    ^ line
  ]


__TRASHTALK_SOURCE_EOF__
}

__Yutani__Session__sessionId() {
  echo "$(_ivar sessionId)"; return
}

__Yutani__Session__sessionId_() {
  _ivar_set sessionId "$1"
}

__Yutani__Session__host() {
  echo "$(_ivar host)"; return
}

__Yutani__Session__host_() {
  _ivar_set host "$1"
}

__Yutani__Session__eventCoproc() {
  echo "$(_ivar eventCoproc)"; return
}

__Yutani__Session__eventCoproc_() {
  _ivar_set eventCoproc "$1"
}

__Yutani__Session__grpcClient() {
  echo "$(_ivar grpcClient)"; return
}

__Yutani__Session__grpcClient_() {
  _ivar_set grpcClient "$1"
}

__Yutani__Session__eventDispatcher() {
  echo "$(_ivar eventDispatcher)"; return
}

__Yutani__Session__eventDispatcher_() {
  _ivar_set eventDispatcher "$1"
}

__Yutani__Session__class__connectTo_() {
  local theHost="$1"
  local client session builder json response sid _
  client="$(@ GrpcClient connectTo_ "$theHost")"
  _="$(@ "$client" enablePooling)"
  session="$(@ Yutani::Session new)"
  _="$(@ "$session" setHost_ "$theHost")"
  _="$(@ "$session" setGrpcClient_ "$client")"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_put_ client_name trashtalk)"
  json="$(@ "$builder" build)"
  response="$(@ "$client" call_with_ "industries.loosh.yutani.v1.SessionService/CreateSession" "$json")"
  sid="$(@ String jsonPath_from_ sessionId.id "$response")"
  _="$(@ "$session" setSessionId_ "$sid")"
  echo "$session"; return
}

__Yutani__Session__class__connect() {
  @ Yutani::Session connectTo_ "localhost:7755"
}

__Yutani__Session__getSessionId() {
  echo "$(_ivar sessionId)"; return
}

__Yutani__Session__getHost() {
  echo "$(_ivar host)"; return
}

__Yutani__Session__getGrpcClient() {
  echo "$(_ivar grpcClient)"; return
}

__Yutani__Session__setSessionId_() {
  local sid="$1"
  _ivar_set sessionId "$sid"
}

__Yutani__Session__setHost_() {
  local h="$1"
  _ivar_set host "$h"
}

__Yutani__Session__setGrpcClient_() {
  local client="$1"
  _ivar_set grpcClient "$client"
}

__Yutani__Session__disconnect() {
  @ "$_RECEIVER" destroySession
  @ "$_RECEIVER" stopEventStream
}

__Yutani__Session__destroySession() {
  local json
  json="$(@ Json sessionId_ "$(_ivar sessionId)")"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.SessionService/DestroySession" "$json"
}

__Yutani__Session__ping() {
  local ts builder json _
  ts="$(@ Time now)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putNumber_ timestamp "$ts")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.SessionService/Ping" "$json"
}

__Yutani__Session__serverInfo() {
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.SessionService/GetServerInfo" "{}"
}

__Yutani__Session__screenSize() {
  local json
  json="$(@ Json sessionId_ "$(_ivar sessionId)")"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.ScreenService/GetSize" "$json"
}

__Yutani__Session__clearScreen() {
  local json
  json="$(@ Json sessionId_ "$(_ivar sessionId)")"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.ScreenService/Clear" "$json"
}

__Yutani__Session__sync() {
  local json
  json="$(@ Json sessionId_ "$(_ivar sessionId)")"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.ScreenService/Sync" "$json"
}

__Yutani__Session__createList_() {
  local title="$1"
  local sidBuilder propsBuilder builder sidJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at_putBool_ border true)"
  _="$(@ "$propsBuilder" at_put_ title "$title")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_put_ type WIDGET_LIST)"
  _="$(@ "$builder" at_putJson_ properties "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/CreateWidget" "$json")"
  echo "$(@ String jsonPath_from_ widgetId.id "$response")"; return
}

__Yutani__Session__createTextView_() {
  local title="$1"
  local sidBuilder tvBuilder propsBuilder builder sidJson tvJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  tvBuilder="$(@ Json object)"
  _="$(@ "$tvBuilder" at_putBool_ word_wrap true)"
  _="$(@ "$tvBuilder" at_putBool_ dynamic_colors true)"
  tvJson="$(@ "$tvBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at_putBool_ border true)"
  _="$(@ "$propsBuilder" at_put_ title "$title")"
  _="$(@ "$propsBuilder" at_putJson_ text_view "$tvJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_put_ type WIDGET_TEXT_VIEW)"
  _="$(@ "$builder" at_putJson_ properties "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/CreateWidget" "$json")"
  echo "$(@ String jsonPath_from_ widgetId.id "$response")"; return
}

__Yutani__Session__createTextViewWithText_text_() {
  local title="$1"
  local text="$2"
  local sidBuilder tvBuilder propsBuilder builder sidJson tvJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  tvBuilder="$(@ Json object)"
  _="$(@ "$tvBuilder" at_put_ text "$text")"
  _="$(@ "$tvBuilder" at_putBool_ word_wrap true)"
  _="$(@ "$tvBuilder" at_putBool_ dynamic_colors true)"
  tvJson="$(@ "$tvBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at_putBool_ border true)"
  _="$(@ "$propsBuilder" at_put_ title "$title")"
  _="$(@ "$propsBuilder" at_putJson_ text_view "$tvJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_put_ type WIDGET_TEXT_VIEW)"
  _="$(@ "$builder" at_putJson_ properties "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/CreateWidget" "$json")"
  echo "$(@ String jsonPath_from_ widgetId.id "$response")"; return
}

__Yutani__Session__createInputField_() {
  local label="$1"
  local sidBuilder ifBuilder propsBuilder builder sidJson ifJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  ifBuilder="$(@ Json object)"
  _="$(@ "$ifBuilder" at_put_ label "$label")"
  _="$(@ "$ifBuilder" at_put_ placeholder )"
  _="$(@ "$ifBuilder" at_put_ text )"
  ifJson="$(@ "$ifBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at_putBool_ border true)"
  _="$(@ "$propsBuilder" at_putJson_ input_field "$ifJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_put_ type WIDGET_INPUT_FIELD)"
  _="$(@ "$builder" at_putJson_ properties "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/CreateWidget" "$json")"
  echo "$(@ String jsonPath_from_ widgetId.id "$response")"; return
}

__Yutani__Session__createInputFieldWithPlaceholder_placeholder_() {
  local label="$1"
  local placeholder="$2"
  local sidBuilder ifBuilder propsBuilder builder sidJson ifJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  ifBuilder="$(@ Json object)"
  _="$(@ "$ifBuilder" at_put_ label "$label")"
  _="$(@ "$ifBuilder" at_put_ placeholder "$placeholder")"
  _="$(@ "$ifBuilder" at_put_ text )"
  ifJson="$(@ "$ifBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at_putBool_ border true)"
  _="$(@ "$propsBuilder" at_putJson_ input_field "$ifJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_put_ type WIDGET_INPUT_FIELD)"
  _="$(@ "$builder" at_putJson_ properties "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/CreateWidget" "$json")"
  echo "$(@ String jsonPath_from_ widgetId.id "$response")"; return
}

__Yutani__Session__createHorizontalLayout() {
  local sidBuilder flexBuilder propsBuilder builder sidJson flexJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  flexBuilder="$(@ Json object)"
  _="$(@ "$flexBuilder" at_put_ direction FLEX_COLUMN)"
  flexJson="$(@ "$flexBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at_putJson_ flex "$flexJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_put_ type WIDGET_FLEX)"
  _="$(@ "$builder" at_putJson_ properties "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/CreateWidget" "$json")"
  echo "$(@ String jsonPath_from_ widgetId.id "$response")"; return
}

__Yutani__Session__createVerticalLayout() {
  local sidBuilder flexBuilder propsBuilder builder sidJson flexJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  flexBuilder="$(@ Json object)"
  _="$(@ "$flexBuilder" at_put_ direction FLEX_ROW)"
  flexJson="$(@ "$flexBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at_putJson_ flex "$flexJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_put_ type WIDGET_FLEX)"
  _="$(@ "$builder" at_putJson_ properties "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/CreateWidget" "$json")"
  echo "$(@ String jsonPath_from_ widgetId.id "$response")"; return
}

__Yutani__Session__setText_on_() {
  local text="$1"
  local wid="$2"
  local sidBuilder widBuilder tvBuilder propsBuilder builder sidJson widJson tvJson propsJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  widBuilder="$(@ Json object)"
  _="$(@ "$widBuilder" at_put_ id "$wid")"
  widJson="$(@ "$widBuilder" build)"
  tvBuilder="$(@ Json object)"
  _="$(@ "$tvBuilder" at_put_ text "$text")"
  tvJson="$(@ "$tvBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at_putJson_ text_view "$tvJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_putJson_ widget_id "$widJson")"
  _="$(@ "$builder" at_putJson_ properties "$propsJson")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/SetProperties" "$json"
}

__Yutani__Session__setInputText_on_() {
  local text="$1"
  local wid="$2"
  local sidBuilder widBuilder ifBuilder propsBuilder builder sidJson widJson ifJson propsJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  widBuilder="$(@ Json object)"
  _="$(@ "$widBuilder" at_put_ id "$wid")"
  widJson="$(@ "$widBuilder" build)"
  ifBuilder="$(@ Json object)"
  _="$(@ "$ifBuilder" at_put_ text "$text")"
  ifJson="$(@ "$ifBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at_putJson_ input_field "$ifJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_putJson_ widget_id "$widJson")"
  _="$(@ "$builder" at_putJson_ properties "$propsJson")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/SetProperties" "$json"
}

__Yutani__Session__getInputText_() {
  local wid="$1"
  local json response result
  json="$(@ Json sessionId_widgetId_ "$(_ivar sessionId)" "$wid")"
  response="$(@ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/GetProperties" "$json")"
  result="$(@ String jsonPath_from_ properties.inputField.text "$response")"
  if [[ -z "$result" ]]; then
    result="$(@ String jsonPath_from_ properties.input_field.text "$response")"
  fi
  echo "$result"; return
}

__Yutani__Session__focusWidget_() {
  local wid="$1"
  local json
  json="$(@ Json sessionId_widgetId_ "$(_ivar sessionId)" "$wid")"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/SetFocus" "$json"
}

__Yutani__Session__setRoot_() {
  local wid="$1"
  local json
  json="$(@ Json sessionId_widgetId_ "$(_ivar sessionId)" "$wid")"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/SetRoot" "$json"
}

__Yutani__Session__listWidgets() {
  local json
  json="$(@ Json sessionId_ "$(_ivar sessionId)")"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/ListWidgets" "$json"
}

__Yutani__Session__deleteWidget_() {
  local wid="$1"
  local json
  json="$(@ Json sessionId_widgetId_ "$(_ivar sessionId)" "$wid")"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.WidgetService/DeleteWidget" "$json"
}

__Yutani__Session__addItem_to_() {
  local mainText="$1"
  local listId="$2"
  local sidBuilder widBuilder builder sidJson widJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  widBuilder="$(@ Json object)"
  _="$(@ "$widBuilder" at_put_ id "$listId")"
  widJson="$(@ "$widBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_putJson_ widget_id "$widJson")"
  _="$(@ "$builder" at_put_ main_text "$mainText")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.ListService/AddItem" "$json"
}

__Yutani__Session__addItem_secondary_to_() {
  local mainText="$1"
  local secondaryText="$2"
  local listId="$3"
  local sidBuilder widBuilder builder sidJson widJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  widBuilder="$(@ Json object)"
  _="$(@ "$widBuilder" at_put_ id "$listId")"
  widJson="$(@ "$widBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_putJson_ widget_id "$widJson")"
  _="$(@ "$builder" at_put_ main_text "$mainText")"
  _="$(@ "$builder" at_put_ secondary_text "$secondaryText")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.ListService/AddItem" "$json"
}

__Yutani__Session__clearList_() {
  local listId="$1"
  local json
  json="$(@ Json sessionId_widgetId_ "$(_ivar sessionId)" "$listId")"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.ListService/Clear" "$json"
}

__Yutani__Session__addChild_to_() {
  local childId="$1"
  local layoutId="$2"
  local sidBuilder flexBuilder itemBuilder builder sidJson flexJson itemJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  flexBuilder="$(@ Json object)"
  _="$(@ "$flexBuilder" at_put_ id "$layoutId")"
  flexJson="$(@ "$flexBuilder" build)"
  itemBuilder="$(@ Json object)"
  _="$(@ "$itemBuilder" at_put_ id "$childId")"
  itemJson="$(@ "$itemBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_putJson_ flex_id "$flexJson")"
  _="$(@ "$builder" at_putJson_ item_id "$itemJson")"
  _="$(@ "$builder" at_putNumber_ proportion 1)"
  _="$(@ "$builder" at_putNumber_ fixed_size 0)"
  _="$(@ "$builder" at_putBool_ focus false)"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.LayoutService/FlexAddItem" "$json"
}

__Yutani__Session__addChild_to_fixedSize_() {
  local childId="$1"
  local layoutId="$2"
  local size="$3"
  local sidBuilder flexBuilder itemBuilder builder sidJson flexJson itemJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  flexBuilder="$(@ Json object)"
  _="$(@ "$flexBuilder" at_put_ id "$layoutId")"
  flexJson="$(@ "$flexBuilder" build)"
  itemBuilder="$(@ Json object)"
  _="$(@ "$itemBuilder" at_put_ id "$childId")"
  itemJson="$(@ "$itemBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_putJson_ flex_id "$flexJson")"
  _="$(@ "$builder" at_putJson_ item_id "$itemJson")"
  _="$(@ "$builder" at_putNumber_ proportion 0)"
  _="$(@ "$builder" at_putNumber_ fixed_size "$size")"
  _="$(@ "$builder" at_putBool_ focus false)"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.LayoutService/FlexAddItem" "$json"
}

__Yutani__Session__addChild_to_fixedSize_focus_() {
  local childId="$1"
  local layoutId="$2"
  local size="$3"
  local shouldFocus="$4"
  local sidBuilder flexBuilder itemBuilder builder sidJson flexJson itemJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  flexBuilder="$(@ Json object)"
  _="$(@ "$flexBuilder" at_put_ id "$layoutId")"
  flexJson="$(@ "$flexBuilder" build)"
  itemBuilder="$(@ Json object)"
  _="$(@ "$itemBuilder" at_put_ id "$childId")"
  itemJson="$(@ "$itemBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_putJson_ flex_id "$flexJson")"
  _="$(@ "$builder" at_putJson_ item_id "$itemJson")"
  _="$(@ "$builder" at_putNumber_ proportion 0)"
  _="$(@ "$builder" at_putNumber_ fixed_size "$size")"
  _="$(@ "$builder" at_putBool_ focus "$shouldFocus")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call_with_ "industries.loosh.yutani.v1.LayoutService/FlexAddItem" "$json"
}

__Yutani__Session__streamEventsWithBlock_() {
  local block="$1"
  local sidBuilder filterBuilder builder sidJson filterJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  filterBuilder="$(@ Json object)"
  _="$(@ "$filterBuilder" at_putBool_ receive_key_events true)"
  _="$(@ "$filterBuilder" at_putBool_ receive_mouse_events true)"
  _="$(@ "$filterBuilder" at_putBool_ receive_resize_events true)"
  _="$(@ "$filterBuilder" at_putBool_ receive_focus_events true)"
  _="$(@ "$filterBuilder" at_putBool_ receive_widget_events true)"
  filterJson="$(@ "$filterBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_putJson_ filter "$filterJson")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" serverStream_with_handler_ "industries.loosh.yutani.v1.EventService/Subscribe" "$json" "$block"
}

__Yutani__Session__runEventLoopWithDispatcher_() {
  local aDispatcher="$1"
  _ivar_set eventDispatcher "$aDispatcher"
  @ "$_RECEIVER" streamEventsWithBlock_ "$_RECEIVER"
}

__Yutani__Session__valueWith_() {
  local json="$1"
  if [[ -n "$(_ivar eventDispatcher)" ]]; then
    @ "$(_ivar eventDispatcher)" dispatchJson_ "$json"
  fi
}

__Yutani__Session__startEventStream() {
  local sidBuilder filterBuilder builder sidJson filterJson json tmpFile cmd cmdPart1 cmdPart2 ec f _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at_put_ id "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  filterBuilder="$(@ Json object)"
  _="$(@ "$filterBuilder" at_putBool_ receive_key_events true)"
  _="$(@ "$filterBuilder" at_putBool_ receive_mouse_events true)"
  _="$(@ "$filterBuilder" at_putBool_ receive_resize_events true)"
  _="$(@ "$filterBuilder" at_putBool_ receive_focus_events true)"
  _="$(@ "$filterBuilder" at_putBool_ receive_widget_events true)"
  filterJson="$(@ "$filterBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at_putJson_ session_id "$sidJson")"
  _="$(@ "$builder" at_putJson_ filter "$filterJson")"
  json="$(@ "$builder" build)"
  tmpFile="/tmp/yutani_subscribe_filter.json"
  f="$(@ File for_ "$tmpFile")"
  _="$(@ "$f" write_ "$json")"
  cmdPart1="$(@ String concat_with_with_ "grpcurl -plaintext -d @" "$tmpFile" " ")"
  cmdPart2="$(@ String concat_with_ "$(_ivar host)" " industries.loosh.yutani.v1.EventService/Subscribe | jq --unbuffered -c .")"
  cmd="$(@ String concat_with_ "$cmdPart1" "$cmdPart2")"
  ec="$(@ Coproc for_ "$cmd")"
  _="$(@ "$ec" startReadOnly)"
  _ivar_set eventCoproc "$ec"
}

__Yutani__Session__stopEventStream() {
  local ec
  ec="$(_ivar eventCoproc)"
  if [[ -n "$ec" ]]; then
    @ "$ec" terminate
    _ivar_set eventCoproc ""
  fi
}

__Yutani__Session__onEventDo_() {
  local handler="$1"
  local ec
  ec="$(_ivar eventCoproc)"
  if [[ -z "$ec" ]]; then
    @ "$_RECEIVER" startEventStream
    ec="$(_ivar eventCoproc)"
  fi
  @ "$ec" readLinesDo_ "$handler"
}

__Yutani__Session__nextEvent() {
  local ec line
  ec="$(_ivar eventCoproc)"
  if [[ -z "$ec" ]]; then
    @ "$_RECEIVER" startEventStream
    ec="$(_ivar eventCoproc)"
  fi
  line="$(@ "$ec" readLine)"
  echo "$line"; return
}

