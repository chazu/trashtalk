#!/usr/bin/env bash
# Generated by Trashtalk Compiler (jq) - DO NOT EDIT
# Source: Session.trash
# Generated: 2026-01-14T22:33:48

__Yutani__Session__superclass="Object"
__Yutani__Session__instanceVars="sessionId: host:localhost:7755 eventCoproc: grpcClient:"
__Yutani__Session__classInstanceVars=""
__Yutani__Session__traits=""
__Yutani__Session__sourceHash="ee012fd1da710c2658c6c1339fa0d8c38289e615ebae3e1a3c9c0053eb3ae8ad"
__Yutani__Session__package="Yutani"
__Yutani__Session__qualifiedName="Yutani::Session"

__Yutani__Session__source() {
  cat <<'__TRASHTALK_SOURCE_EOF__'
package: Yutani

# Yutani Session - manages connection to Yutani UI server
# Refactored to use GrpcClient for connection pooling and native Procyon support

Session subclass: Object
  instanceVars: sessionId:'' host:'localhost:7755' eventCoproc:'' grpcClient:''

  # ============================================================================
  # Factory Methods
  # ============================================================================

  classMethod: connectTo: theHost [
    | client session builder json response sid _ |
    # Create GrpcClient with pooling enabled
    client := @ GrpcClient connectTo: theHost.
    _ := @ client enablePooling.
    # Create session instance
    session := @ Yutani::Session new.
    _ := $(@ session setHost: theHost).
    _ := $(@ session setGrpcClient: client).
    # Create session on server
    builder := @ Json object.
    _ := @ builder at: 'client_name' put: 'trashtalk'.
    json := @ builder build.
    response := @ client call: 'industries.loosh.yutani.v1.SessionService/CreateSession' with: json.
    sid := response jsonPath: 'sessionId.id'.
    _ := $(@ session setSessionId: sid).
    ^ session
  ]

  classMethod: connect [
    @ Yutani::Session connectTo: 'localhost:7755'
  ]

  # ============================================================================
  # Accessors
  # ============================================================================

  method: getSessionId [ ^ sessionId ]
  method: getHost [ ^ host ]
  method: getGrpcClient [ ^ grpcClient ]

  # ============================================================================
  # Session Lifecycle
  # ============================================================================

  method: disconnect [
    @ self destroySession.
    @ self stopEventStream
  ]

  method: destroySession [
    | json |
    json := @ Json sessionId: sessionId.
    @ grpcClient call: 'industries.loosh.yutani.v1.SessionService/DestroySession' with: json
  ]

  rawMethod: ping [
    pragma: bashOnly
    local ts client json
    ts=$(date +%s)
    client="$(_ivar grpcClient)"
    json=$(jo timestamp="$ts")
    @ "$client" call: 'industries.loosh.yutani.v1.SessionService/Ping' with: "$json"
  ]

  method: serverInfo [
    @ grpcClient call: 'industries.loosh.yutani.v1.SessionService/GetServerInfo' with: '{}'
  ]

  # ============================================================================
  # Screen Operations
  # ============================================================================

  method: screenSize [
    | json |
    json := @ Json sessionId: sessionId.
    @ grpcClient call: 'industries.loosh.yutani.v1.ScreenService/GetSize' with: json
  ]

  method: clearScreen [
    | json |
    json := @ Json sessionId: sessionId.
    @ grpcClient call: 'industries.loosh.yutani.v1.ScreenService/Clear' with: json
  ]

  method: sync [
    | json |
    json := @ Json sessionId: sessionId.
    @ grpcClient call: 'industries.loosh.yutani.v1.ScreenService/Sync' with: json
  ]

  # ============================================================================
  # Widget Creation
  # ============================================================================

  method: createList: title [
    | sidBuilder propsBuilder builder sidJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'border' putBool: 'true'.
    _ := @ propsBuilder at: 'title' put: title.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_LIST'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ response jsonPath: 'widgetId.id'
  ]

  method: createTextView: title [
    | sidBuilder tvBuilder propsBuilder builder sidJson tvJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    tvBuilder := @ Json object.
    _ := @ tvBuilder at: 'word_wrap' putBool: 'true'.
    _ := @ tvBuilder at: 'dynamic_colors' putBool: 'true'.
    tvJson := @ tvBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'border' putBool: 'true'.
    _ := @ propsBuilder at: 'title' put: title.
    _ := @ propsBuilder at: 'text_view' putJson: tvJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_TEXT_VIEW'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ response jsonPath: 'widgetId.id'
  ]

  method: createTextViewWithText: title text: text [
    | sidBuilder tvBuilder propsBuilder builder sidJson tvJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    tvBuilder := @ Json object.
    _ := @ tvBuilder at: 'text' put: text.
    _ := @ tvBuilder at: 'word_wrap' putBool: 'true'.
    _ := @ tvBuilder at: 'dynamic_colors' putBool: 'true'.
    tvJson := @ tvBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'border' putBool: 'true'.
    _ := @ propsBuilder at: 'title' put: title.
    _ := @ propsBuilder at: 'text_view' putJson: tvJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_TEXT_VIEW'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ response jsonPath: 'widgetId.id'
  ]

  method: createInputField: label [
    | sidBuilder ifBuilder propsBuilder builder sidJson ifJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    ifBuilder := @ Json object.
    _ := @ ifBuilder at: 'label' put: label.
    _ := @ ifBuilder at: 'placeholder' put: ''.
    _ := @ ifBuilder at: 'text' put: ''.
    ifJson := @ ifBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'border' putBool: 'true'.
    _ := @ propsBuilder at: 'input_field' putJson: ifJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_INPUT_FIELD'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ response jsonPath: 'widgetId.id'
  ]

  method: createInputFieldWithPlaceholder: label placeholder: placeholder [
    | sidBuilder ifBuilder propsBuilder builder sidJson ifJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    ifBuilder := @ Json object.
    _ := @ ifBuilder at: 'label' put: label.
    _ := @ ifBuilder at: 'placeholder' put: placeholder.
    _ := @ ifBuilder at: 'text' put: ''.
    ifJson := @ ifBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'border' putBool: 'true'.
    _ := @ propsBuilder at: 'input_field' putJson: ifJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_INPUT_FIELD'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ response jsonPath: 'widgetId.id'
  ]

  # FLEX_COLUMN = items side by side (horizontal)
  method: createHorizontalLayout [
    | sidBuilder flexBuilder propsBuilder builder sidJson flexJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    flexBuilder := @ Json object.
    _ := @ flexBuilder at: 'direction' put: 'FLEX_COLUMN'.
    flexJson := @ flexBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'flex' putJson: flexJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_FLEX'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ response jsonPath: 'widgetId.id'
  ]

  # FLEX_ROW = items stacked vertically (top to bottom)
  method: createVerticalLayout [
    | sidBuilder flexBuilder propsBuilder builder sidJson flexJson propsJson json response _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    flexBuilder := @ Json object.
    _ := @ flexBuilder at: 'direction' put: 'FLEX_ROW'.
    flexJson := @ flexBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'flex' putJson: flexJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'type' put: 'WIDGET_FLEX'.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: json.
    ^ response jsonPath: 'widgetId.id'
  ]

  # ============================================================================
  # Widget Operations
  # ============================================================================

  method: setText: text on: wid [
    | sidBuilder widBuilder tvBuilder propsBuilder builder sidJson widJson tvJson propsJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    widBuilder := @ Json object.
    _ := @ widBuilder at: 'id' put: wid.
    widJson := @ widBuilder build.
    tvBuilder := @ Json object.
    _ := @ tvBuilder at: 'text' put: text.
    tvJson := @ tvBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'text_view' putJson: tvJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'widget_id' putJson: widJson.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/SetProperties' with: json
  ]

  method: setInputText: text on: wid [
    | sidBuilder widBuilder ifBuilder propsBuilder builder sidJson widJson ifJson propsJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    widBuilder := @ Json object.
    _ := @ widBuilder at: 'id' put: wid.
    widJson := @ widBuilder build.
    ifBuilder := @ Json object.
    _ := @ ifBuilder at: 'text' put: text.
    ifJson := @ ifBuilder build.
    propsBuilder := @ Json object.
    _ := @ propsBuilder at: 'input_field' putJson: ifJson.
    propsJson := @ propsBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'widget_id' putJson: widJson.
    _ := @ builder at: 'properties' putJson: propsJson.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/SetProperties' with: json
  ]

  method: getInputText: wid [
    | json response result |
    json := @ Json sessionId: sessionId widgetId: wid.
    response := @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/GetProperties' with: json.
    # Try camelCase first, then snake_case
    result := response jsonPath: 'properties.inputField.text'.
    result isEmpty ifTrue: [
      result := response jsonPath: 'properties.input_field.text'
    ].
    ^ result
  ]

  method: focusWidget: wid [
    | json |
    json := @ Json sessionId: sessionId widgetId: wid.
    @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/SetFocus' with: json
  ]

  method: setRoot: wid [
    | json |
    json := @ Json sessionId: sessionId widgetId: wid.
    @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/SetRoot' with: json
  ]

  method: listWidgets [
    | json |
    json := @ Json sessionId: sessionId.
    @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/ListWidgets' with: json
  ]

  method: deleteWidget: wid [
    | json |
    json := @ Json sessionId: sessionId widgetId: wid.
    @ grpcClient call: 'industries.loosh.yutani.v1.WidgetService/DeleteWidget' with: json
  ]

  # ============================================================================
  # List Operations
  # ============================================================================

  method: addItem: mainText to: listId [
    | sidBuilder widBuilder builder sidJson widJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    widBuilder := @ Json object.
    _ := @ widBuilder at: 'id' put: listId.
    widJson := @ widBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'widget_id' putJson: widJson.
    _ := @ builder at: 'main_text' put: mainText.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.ListService/AddItem' with: json
  ]

  method: addItem: mainText secondary: secondaryText to: listId [
    | sidBuilder widBuilder builder sidJson widJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    widBuilder := @ Json object.
    _ := @ widBuilder at: 'id' put: listId.
    widJson := @ widBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'widget_id' putJson: widJson.
    _ := @ builder at: 'main_text' put: mainText.
    _ := @ builder at: 'secondary_text' put: secondaryText.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.ListService/AddItem' with: json
  ]

  method: clearList: listId [
    | json |
    json := @ Json sessionId: sessionId widgetId: listId.
    @ grpcClient call: 'industries.loosh.yutani.v1.ListService/Clear' with: json
  ]

  # ============================================================================
  # Layout Operations
  # ============================================================================

  method: addChild: childId to: layoutId [
    | sidBuilder flexBuilder itemBuilder builder sidJson flexJson itemJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    flexBuilder := @ Json object.
    _ := @ flexBuilder at: 'id' put: layoutId.
    flexJson := @ flexBuilder build.
    itemBuilder := @ Json object.
    _ := @ itemBuilder at: 'id' put: childId.
    itemJson := @ itemBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'flex_id' putJson: flexJson.
    _ := @ builder at: 'item_id' putJson: itemJson.
    _ := @ builder at: 'proportion' putNumber: '1'.
    _ := @ builder at: 'fixed_size' putNumber: '0'.
    _ := @ builder at: 'focus' putBool: 'false'.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: json
  ]

  method: addChild: childId to: layoutId fixedSize: size [
    | sidBuilder flexBuilder itemBuilder builder sidJson flexJson itemJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    flexBuilder := @ Json object.
    _ := @ flexBuilder at: 'id' put: layoutId.
    flexJson := @ flexBuilder build.
    itemBuilder := @ Json object.
    _ := @ itemBuilder at: 'id' put: childId.
    itemJson := @ itemBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'flex_id' putJson: flexJson.
    _ := @ builder at: 'item_id' putJson: itemJson.
    _ := @ builder at: 'proportion' putNumber: '0'.
    _ := @ builder at: 'fixed_size' putNumber: size.
    _ := @ builder at: 'focus' putBool: 'false'.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: json
  ]

  method: addChild: childId to: layoutId fixedSize: size focus: shouldFocus [
    | sidBuilder flexBuilder itemBuilder builder sidJson flexJson itemJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    flexBuilder := @ Json object.
    _ := @ flexBuilder at: 'id' put: layoutId.
    flexJson := @ flexBuilder build.
    itemBuilder := @ Json object.
    _ := @ itemBuilder at: 'id' put: childId.
    itemJson := @ itemBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'flex_id' putJson: flexJson.
    _ := @ builder at: 'item_id' putJson: itemJson.
    _ := @ builder at: 'proportion' putNumber: '0'.
    _ := @ builder at: 'fixed_size' putNumber: size.
    _ := @ builder at: 'focus' putBool: shouldFocus.
    json := @ builder build.
    @ grpcClient call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: json
  ]

  # ============================================================================
  # Event Streaming - Native (preferred) or Coproc (fallback)
  # ============================================================================

  # Native streaming using GrpcClient.serverStream (requires native daemon)
  # This is the preferred method - uses persistent gRPC connection, no subprocess
  # The block receives JSON event data for each streamed message
  method: streamEventsWithBlock: block [
    | sidBuilder filterBuilder builder sidJson filterJson json _ |
    sidBuilder := @ Json object.
    _ := @ sidBuilder at: 'id' put: sessionId.
    sidJson := @ sidBuilder build.
    filterBuilder := @ Json object.
    _ := @ filterBuilder at: 'receive_key_events' putBool: 'true'.
    _ := @ filterBuilder at: 'receive_mouse_events' putBool: 'true'.
    _ := @ filterBuilder at: 'receive_resize_events' putBool: 'true'.
    _ := @ filterBuilder at: 'receive_focus_events' putBool: 'true'.
    _ := @ filterBuilder at: 'receive_widget_events' putBool: 'true'.
    filterJson := @ filterBuilder build.
    builder := @ Json object.
    _ := @ builder at: 'session_id' putJson: sidJson.
    _ := @ builder at: 'filter' putJson: filterJson.
    json := @ builder build.
    @ grpcClient serverStream: 'industries.loosh.yutani.v1.EventService/Subscribe' with: json handler: block
  ]

  # High-level streaming with EventDispatcher integration
  # Creates Event objects and dispatches them through the provided dispatcher
  # Usage: @ $session runEventLoopWithDispatcher: $dispatcher
  # (bash-specific: string interpolation for block creation)
  rawMethod: runEventLoopWithDispatcher: dispatcher [
    pragma: bashOnly
    pragma: direct
    local dispatcher="$1" handlerBlock

    # Create a block that converts JSON to Event and dispatches it
    handlerBlock=$(@ Block new: "
      local json=\"\$1\"
      @ \"$dispatcher\" dispatchJson: \"\$json\"
    ")

    # Start streaming - this blocks until stream ends/errors
    @ "$_RECEIVER" streamEventsWithBlock: "$handlerBlock"
  ]

  # ============================================================================
  # Fallback: Coproc-based streaming (for when native daemon unavailable)
  # ============================================================================

  # (bash-specific: jo for JSON, command string building, coproc usage)
  rawMethod: startEventStream [
    pragma: bashOnly
    local sid filter_json host evt_coproc cmd
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"

    # Build filter JSON
    filter_json=$(jo session_id="$(jo id="$sid")" \
      filter="$(jo receive_key_events=true receive_mouse_events=true \
        receive_resize_events=true receive_focus_events=true receive_widget_events=true)")

    # Build the grpcurl command - pipe through jq -c to get compact single-line JSON
    # Use --unbuffered to prevent jq from buffering output
    cmd="grpcurl -plaintext -d '$filter_json' $host industries.loosh.yutani.v1.EventService/Subscribe | jq --unbuffered -c ."

    # Create and start coproc
    evt_coproc=$(@ Coproc for: "$cmd")
    @ "$evt_coproc" startReadOnly

    _ivar_set eventCoproc "$evt_coproc"
  ]

  # (bash-specific: conditional branching)
  rawMethod: stopEventStream [
    pragma: bashOnly
    local evt_coproc
    evt_coproc="$(_ivar eventCoproc)"

    if [[ -n "$evt_coproc" ]]; then
      @ "$evt_coproc" terminate
      _ivar_set eventCoproc ""
    fi
  ]

  # Process events with a handler (coproc mode). Handler can read $__COPROC_LINE.
  # Usage: @ $session onEventDo: '@ $obj handleEvent'
  # (bash-specific: conditional branching)
  rawMethod: onEventDo: handler [
    pragma: bashOnly
    local evt_coproc handler="$1"
    evt_coproc="$(_ivar eventCoproc)"

    # Start stream if not already running
    if [[ -z "$evt_coproc" ]]; then
      @ "$_RECEIVER" startEventStream
      evt_coproc="$(_ivar eventCoproc)"
    fi

    # Read lines continuously, calling handler for each
    @ "$evt_coproc" readLinesDo: "$handler"
  ]

  # (bash-specific: conditional branching)
  rawMethod: nextEvent [
    pragma: bashOnly
    local evt_coproc line
    evt_coproc="$(_ivar eventCoproc)"

    # Start stream if not already running
    if [[ -z "$evt_coproc" ]]; then
      @ "$_RECEIVER" startEventStream
      evt_coproc="$(_ivar eventCoproc)"
    fi

    # Read next line (blocks until event arrives)
    line=$(@ "$evt_coproc" readLine)
    echo "$line"
  ]
__TRASHTALK_SOURCE_EOF__
}

__Yutani__Session__sessionId() {
  echo "$(_ivar sessionId)"; return
}

__Yutani__Session__sessionId_() {
  _ivar_set sessionId "$1"
}

__Yutani__Session__getSessionId() {
  echo "$(_ivar sessionId)"; return
}

__Yutani__Session__setSessionId_() {
  _ivar_set sessionId "$1"
}
__Yutani__Session__host() {
  echo "$(_ivar host)"; return
}

__Yutani__Session__host_() {
  _ivar_set host "$1"
}

__Yutani__Session__getHost() {
  echo "$(_ivar host)"; return
}

__Yutani__Session__setHost_() {
  _ivar_set host "$1"
}
__Yutani__Session__eventCoproc() {
  echo "$(_ivar eventCoproc)"; return
}

__Yutani__Session__eventCoproc_() {
  _ivar_set eventCoproc "$1"
}

__Yutani__Session__getEventCoproc() {
  echo "$(_ivar eventCoproc)"; return
}

__Yutani__Session__setEventCoproc_() {
  _ivar_set eventCoproc "$1"
}
__Yutani__Session__grpcClient() {
  echo "$(_ivar grpcClient)"; return
}

__Yutani__Session__grpcClient_() {
  _ivar_set grpcClient "$1"
}

__Yutani__Session__getGrpcClient() {
  echo "$(_ivar grpcClient)"; return
}

__Yutani__Session__setGrpcClient_() {
  _ivar_set grpcClient "$1"
}

__Yutani__Session__class__connectTo_() {
  local theHost="$1"
  local client session builder json response sid _
  client="$(@ GrpcClient connectTo: "$theHost")"
  _="$(@ "$client" enablePooling)"
  session="$(@ Yutani::Session new)"
  _="$(@ "$session" setHost: "$theHost")"
  _="$(@ "$session" setGrpcClient: "$client")"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'client_name' put: 'trashtalk')"
  json="$(@ "$builder" build)"
  response="$(@ "$client" call: 'industries.loosh.yutani.v1.SessionService/CreateSession' with: "$json")"
  sid="$(echo "$response" | jq -r '.sessionId.id // empty')"
  _="$(@ "$session" setSessionId: "$sid")"
  echo "$session"; return
}

__Yutani__Session__class__connect() {
  @ Yutani::Session connectTo: 'localhost:7755'
}

__Yutani__Session__getSessionId() {
  echo "$(_ivar sessionId)"; return
}

__Yutani__Session__getHost() {
  echo "$(_ivar host)"; return
}

__Yutani__Session__getGrpcClient() {
  echo "$(_ivar grpcClient)"; return
}

__Yutani__Session__disconnect() {
  @ "$_RECEIVER" destroySession
  @ "$_RECEIVER" stopEventStream
}

__Yutani__Session__destroySession() {
  local json
  json="$(@ Json sessionId: "$(_ivar sessionId)")"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.SessionService/DestroySession' with: "$json"
}

declare -g __Yutani__Session__ping__bashOnly=1
__Yutani__Session__ping() {
    local ts client json
    ts=$(date +%s)
    client="$(_ivar grpcClient)"
    json=$(jo timestamp="$ts")
    @ "$client" call: 'industries.loosh.yutani.v1.SessionService/Ping' with: "$json"
}

__Yutani__Session__serverInfo() {
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.SessionService/GetServerInfo' with: '{}'
}

__Yutani__Session__screenSize() {
  local json
  json="$(@ Json sessionId: "$(_ivar sessionId)")"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.ScreenService/GetSize' with: "$json"
}

__Yutani__Session__clearScreen() {
  local json
  json="$(@ Json sessionId: "$(_ivar sessionId)")"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.ScreenService/Clear' with: "$json"
}

__Yutani__Session__sync() {
  local json
  json="$(@ Json sessionId: "$(_ivar sessionId)")"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.ScreenService/Sync' with: "$json"
}

__Yutani__Session__createList_() {
  local title="$1"
  local sidBuilder propsBuilder builder sidJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at: 'border' putBool: 'true')"
  _="$(@ "$propsBuilder" at: 'title' put: "$title")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'type' put: 'WIDGET_LIST')"
  _="$(@ "$builder" at: 'properties' putJson: "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")"
  echo "$(echo "$response" | jq -r '.widgetId.id // empty')"; return
}

__Yutani__Session__createTextView_() {
  local title="$1"
  local sidBuilder tvBuilder propsBuilder builder sidJson tvJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  tvBuilder="$(@ Json object)"
  _="$(@ "$tvBuilder" at: 'word_wrap' putBool: 'true')"
  _="$(@ "$tvBuilder" at: 'dynamic_colors' putBool: 'true')"
  tvJson="$(@ "$tvBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at: 'border' putBool: 'true')"
  _="$(@ "$propsBuilder" at: 'title' put: "$title")"
  _="$(@ "$propsBuilder" at: 'text_view' putJson: "$tvJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'type' put: 'WIDGET_TEXT_VIEW')"
  _="$(@ "$builder" at: 'properties' putJson: "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")"
  echo "$(echo "$response" | jq -r '.widgetId.id // empty')"; return
}

__Yutani__Session__createTextViewWithText_text_() {
  local title="$1"
  local text="$2"
  local sidBuilder tvBuilder propsBuilder builder sidJson tvJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  tvBuilder="$(@ Json object)"
  _="$(@ "$tvBuilder" at: 'text' put: "$text")"
  _="$(@ "$tvBuilder" at: 'word_wrap' putBool: 'true')"
  _="$(@ "$tvBuilder" at: 'dynamic_colors' putBool: 'true')"
  tvJson="$(@ "$tvBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at: 'border' putBool: 'true')"
  _="$(@ "$propsBuilder" at: 'title' put: "$title")"
  _="$(@ "$propsBuilder" at: 'text_view' putJson: "$tvJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'type' put: 'WIDGET_TEXT_VIEW')"
  _="$(@ "$builder" at: 'properties' putJson: "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")"
  echo "$(echo "$response" | jq -r '.widgetId.id // empty')"; return
}

__Yutani__Session__createInputField_() {
  local label="$1"
  local sidBuilder ifBuilder propsBuilder builder sidJson ifJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  ifBuilder="$(@ Json object)"
  _="$(@ "$ifBuilder" at: 'label' put: "$label")"
  _="$(@ "$ifBuilder" at: 'placeholder' put: '')"
  _="$(@ "$ifBuilder" at: 'text' put: '')"
  ifJson="$(@ "$ifBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at: 'border' putBool: 'true')"
  _="$(@ "$propsBuilder" at: 'input_field' putJson: "$ifJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'type' put: 'WIDGET_INPUT_FIELD')"
  _="$(@ "$builder" at: 'properties' putJson: "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")"
  echo "$(echo "$response" | jq -r '.widgetId.id // empty')"; return
}

__Yutani__Session__createInputFieldWithPlaceholder_placeholder_() {
  local label="$1"
  local placeholder="$2"
  local sidBuilder ifBuilder propsBuilder builder sidJson ifJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  ifBuilder="$(@ Json object)"
  _="$(@ "$ifBuilder" at: 'label' put: "$label")"
  _="$(@ "$ifBuilder" at: 'placeholder' put: "$placeholder")"
  _="$(@ "$ifBuilder" at: 'text' put: '')"
  ifJson="$(@ "$ifBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at: 'border' putBool: 'true')"
  _="$(@ "$propsBuilder" at: 'input_field' putJson: "$ifJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'type' put: 'WIDGET_INPUT_FIELD')"
  _="$(@ "$builder" at: 'properties' putJson: "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")"
  echo "$(echo "$response" | jq -r '.widgetId.id // empty')"; return
}

__Yutani__Session__createHorizontalLayout() {
  local sidBuilder flexBuilder propsBuilder builder sidJson flexJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  flexBuilder="$(@ Json object)"
  _="$(@ "$flexBuilder" at: 'direction' put: 'FLEX_COLUMN')"
  flexJson="$(@ "$flexBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at: 'flex' putJson: "$flexJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'type' put: 'WIDGET_FLEX')"
  _="$(@ "$builder" at: 'properties' putJson: "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")"
  echo "$(echo "$response" | jq -r '.widgetId.id // empty')"; return
}

__Yutani__Session__createVerticalLayout() {
  local sidBuilder flexBuilder propsBuilder builder sidJson flexJson propsJson json response _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  flexBuilder="$(@ Json object)"
  _="$(@ "$flexBuilder" at: 'direction' put: 'FLEX_ROW')"
  flexJson="$(@ "$flexBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at: 'flex' putJson: "$flexJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'type' put: 'WIDGET_FLEX')"
  _="$(@ "$builder" at: 'properties' putJson: "$propsJson")"
  json="$(@ "$builder" build)"
  response="$(@ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/CreateWidget' with: "$json")"
  echo "$(echo "$response" | jq -r '.widgetId.id // empty')"; return
}

__Yutani__Session__setText_on_() {
  local text="$1"
  local wid="$2"
  local sidBuilder widBuilder tvBuilder propsBuilder builder sidJson widJson tvJson propsJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  widBuilder="$(@ Json object)"
  _="$(@ "$widBuilder" at: 'id' put: "$wid")"
  widJson="$(@ "$widBuilder" build)"
  tvBuilder="$(@ Json object)"
  _="$(@ "$tvBuilder" at: 'text' put: "$text")"
  tvJson="$(@ "$tvBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at: 'text_view' putJson: "$tvJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'widget_id' putJson: "$widJson")"
  _="$(@ "$builder" at: 'properties' putJson: "$propsJson")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/SetProperties' with: "$json"
}

__Yutani__Session__setInputText_on_() {
  local text="$1"
  local wid="$2"
  local sidBuilder widBuilder ifBuilder propsBuilder builder sidJson widJson ifJson propsJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  widBuilder="$(@ Json object)"
  _="$(@ "$widBuilder" at: 'id' put: "$wid")"
  widJson="$(@ "$widBuilder" build)"
  ifBuilder="$(@ Json object)"
  _="$(@ "$ifBuilder" at: 'text' put: "$text")"
  ifJson="$(@ "$ifBuilder" build)"
  propsBuilder="$(@ Json object)"
  _="$(@ "$propsBuilder" at: 'input_field' putJson: "$ifJson")"
  propsJson="$(@ "$propsBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'widget_id' putJson: "$widJson")"
  _="$(@ "$builder" at: 'properties' putJson: "$propsJson")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/SetProperties' with: "$json"
}

__Yutani__Session__getInputText_() {
  local wid="$1"
  local json response result
  json="$(@ Json sessionId: "$(_ivar sessionId)" widgetId: "$wid")"
  response="$(@ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/GetProperties' with: "$json")"
  result="$(echo "$response" | jq -r '.properties.inputField.text // empty')"
  if [[ -z "$result" ]]; then result="$(echo "$response" | jq -r '.properties.input_field.text // empty')"; fi
  echo "$result"; return
}

__Yutani__Session__focusWidget_() {
  local wid="$1"
  local json
  json="$(@ Json sessionId: "$(_ivar sessionId)" widgetId: "$wid")"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/SetFocus' with: "$json"
}

__Yutani__Session__setRoot_() {
  local wid="$1"
  local json
  json="$(@ Json sessionId: "$(_ivar sessionId)" widgetId: "$wid")"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/SetRoot' with: "$json"
}

__Yutani__Session__listWidgets() {
  local json
  json="$(@ Json sessionId: "$(_ivar sessionId)")"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/ListWidgets' with: "$json"
}

__Yutani__Session__deleteWidget_() {
  local wid="$1"
  local json
  json="$(@ Json sessionId: "$(_ivar sessionId)" widgetId: "$wid")"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.WidgetService/DeleteWidget' with: "$json"
}

__Yutani__Session__addItem_to_() {
  local mainText="$1"
  local listId="$2"
  local sidBuilder widBuilder builder sidJson widJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  widBuilder="$(@ Json object)"
  _="$(@ "$widBuilder" at: 'id' put: "$listId")"
  widJson="$(@ "$widBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'widget_id' putJson: "$widJson")"
  _="$(@ "$builder" at: 'main_text' put: "$mainText")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.ListService/AddItem' with: "$json"
}

__Yutani__Session__addItem_secondary_to_() {
  local mainText="$1"
  local secondaryText="$2"
  local listId="$3"
  local sidBuilder widBuilder builder sidJson widJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  widBuilder="$(@ Json object)"
  _="$(@ "$widBuilder" at: 'id' put: "$listId")"
  widJson="$(@ "$widBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'widget_id' putJson: "$widJson")"
  _="$(@ "$builder" at: 'main_text' put: "$mainText")"
  _="$(@ "$builder" at: 'secondary_text' put: "$secondaryText")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.ListService/AddItem' with: "$json"
}

__Yutani__Session__clearList_() {
  local listId="$1"
  local json
  json="$(@ Json sessionId: "$(_ivar sessionId)" widgetId: "$listId")"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.ListService/Clear' with: "$json"
}

__Yutani__Session__addChild_to_() {
  local childId="$1"
  local layoutId="$2"
  local sidBuilder flexBuilder itemBuilder builder sidJson flexJson itemJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  flexBuilder="$(@ Json object)"
  _="$(@ "$flexBuilder" at: 'id' put: "$layoutId")"
  flexJson="$(@ "$flexBuilder" build)"
  itemBuilder="$(@ Json object)"
  _="$(@ "$itemBuilder" at: 'id' put: "$childId")"
  itemJson="$(@ "$itemBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'flex_id' putJson: "$flexJson")"
  _="$(@ "$builder" at: 'item_id' putJson: "$itemJson")"
  _="$(@ "$builder" at: 'proportion' putNumber: '1')"
  _="$(@ "$builder" at: 'fixed_size' putNumber: '0')"
  _="$(@ "$builder" at: 'focus' putBool: 'false')"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: "$json"
}

__Yutani__Session__addChild_to_fixedSize_() {
  local childId="$1"
  local layoutId="$2"
  local size="$3"
  local sidBuilder flexBuilder itemBuilder builder sidJson flexJson itemJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  flexBuilder="$(@ Json object)"
  _="$(@ "$flexBuilder" at: 'id' put: "$layoutId")"
  flexJson="$(@ "$flexBuilder" build)"
  itemBuilder="$(@ Json object)"
  _="$(@ "$itemBuilder" at: 'id' put: "$childId")"
  itemJson="$(@ "$itemBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'flex_id' putJson: "$flexJson")"
  _="$(@ "$builder" at: 'item_id' putJson: "$itemJson")"
  _="$(@ "$builder" at: 'proportion' putNumber: '0')"
  _="$(@ "$builder" at: 'fixed_size' putNumber: "$size")"
  _="$(@ "$builder" at: 'focus' putBool: 'false')"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: "$json"
}

__Yutani__Session__addChild_to_fixedSize_focus_() {
  local childId="$1"
  local layoutId="$2"
  local size="$3"
  local shouldFocus="$4"
  local sidBuilder flexBuilder itemBuilder builder sidJson flexJson itemJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  flexBuilder="$(@ Json object)"
  _="$(@ "$flexBuilder" at: 'id' put: "$layoutId")"
  flexJson="$(@ "$flexBuilder" build)"
  itemBuilder="$(@ Json object)"
  _="$(@ "$itemBuilder" at: 'id' put: "$childId")"
  itemJson="$(@ "$itemBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'flex_id' putJson: "$flexJson")"
  _="$(@ "$builder" at: 'item_id' putJson: "$itemJson")"
  _="$(@ "$builder" at: 'proportion' putNumber: '0')"
  _="$(@ "$builder" at: 'fixed_size' putNumber: "$size")"
  _="$(@ "$builder" at: 'focus' putBool: "$shouldFocus")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" call: 'industries.loosh.yutani.v1.LayoutService/FlexAddItem' with: "$json"
}

__Yutani__Session__streamEventsWithBlock_() {
  local block="$1"
  local sidBuilder filterBuilder builder sidJson filterJson json _
  sidBuilder="$(@ Json object)"
  _="$(@ "$sidBuilder" at: 'id' put: "$(_ivar sessionId)")"
  sidJson="$(@ "$sidBuilder" build)"
  filterBuilder="$(@ Json object)"
  _="$(@ "$filterBuilder" at: 'receive_key_events' putBool: 'true')"
  _="$(@ "$filterBuilder" at: 'receive_mouse_events' putBool: 'true')"
  _="$(@ "$filterBuilder" at: 'receive_resize_events' putBool: 'true')"
  _="$(@ "$filterBuilder" at: 'receive_focus_events' putBool: 'true')"
  _="$(@ "$filterBuilder" at: 'receive_widget_events' putBool: 'true')"
  filterJson="$(@ "$filterBuilder" build)"
  builder="$(@ Json object)"
  _="$(@ "$builder" at: 'session_id' putJson: "$sidJson")"
  _="$(@ "$builder" at: 'filter' putJson: "$filterJson")"
  json="$(@ "$builder" build)"
  @ "$(_ivar grpcClient)" serverStream: 'industries.loosh.yutani.v1.EventService/Subscribe' with: "$json" handler: "$block"
}

declare -g __Yutani__Session__runEventLoopWithDispatcher___bashOnly=1
declare -g __Yutani__Session__runEventLoopWithDispatcher___direct=1
__Yutani__Session__runEventLoopWithDispatcher_() {
  local dispatcher="$1"
    local dispatcher="$1" handlerBlock

    # Create a block that converts JSON to Event and dispatches it
    handlerBlock=$(@ Block new: "
    local json=\"\$1\"
    @ \"$dispatcher\" dispatchJson: \"\$json\"
    ")

    # Start streaming - this blocks until stream ends/errors
    @ "$_RECEIVER" streamEventsWithBlock: "$handlerBlock"
}

declare -g __Yutani__Session__startEventStream__bashOnly=1
__Yutani__Session__startEventStream() {
    local sid filter_json host evt_coproc cmd
    sid="$(_ivar sessionId)"
    host="$(_ivar host)"

    # Build filter JSON
    filter_json=$(jo session_id="$(jo id="$sid")" \
    filter="$(jo receive_key_events=true receive_mouse_events=true \
        receive_resize_events=true receive_focus_events=true receive_widget_events=true)")

    # Build the grpcurl command - pipe through jq -c to get compact single-line JSON
    # Use --unbuffered to prevent jq from buffering output
    cmd="grpcurl -plaintext -d '$filter_json' $host industries.loosh.yutani.v1.EventService/Subscribe | jq --unbuffered -c ."

    # Create and start coproc
    evt_coproc=$(@ Coproc for: "$cmd")
    @ "$evt_coproc" startReadOnly

    _ivar_set eventCoproc "$evt_coproc"
}

declare -g __Yutani__Session__stopEventStream__bashOnly=1
__Yutani__Session__stopEventStream() {
    local evt_coproc
    evt_coproc="$(_ivar eventCoproc)"

    if [[ -n "$evt_coproc" ]]; then
        @ "$evt_coproc" terminate
        _ivar_set eventCoproc ""
    fi
}

declare -g __Yutani__Session__onEventDo___bashOnly=1
__Yutani__Session__onEventDo_() {
  local handler="$1"
    local evt_coproc handler="$1"
    evt_coproc="$(_ivar eventCoproc)"

    # Start stream if not already running
    if [[ -z "$evt_coproc" ]]; then
        @ "$_RECEIVER" startEventStream
        evt_coproc="$(_ivar eventCoproc)"
    fi

    # Read lines continuously, calling handler for each
    @ "$evt_coproc" readLinesDo: "$handler"
}

declare -g __Yutani__Session__nextEvent__bashOnly=1
__Yutani__Session__nextEvent() {
    local evt_coproc line
    evt_coproc="$(_ivar eventCoproc)"

    # Start stream if not already running
    if [[ -z "$evt_coproc" ]]; then
        @ "$_RECEIVER" startEventStream
        evt_coproc="$(_ivar eventCoproc)"
    fi

    # Read next line (blocks until event arrives)
    line=$(@ "$evt_coproc" readLine)
    echo "$line"
}
