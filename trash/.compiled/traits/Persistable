#!/usr/bin/env bash
# Generated by Trashtalk Compiler (procyon) - DO NOT EDIT
# Source: Persistable.trash
# Generated: 2026-01-12T18:32:05

__Persistable__superclass="nil"
__Persistable__instanceVars=""
__Persistable__classInstanceVars=""
__Persistable__traits=""
__Persistable__sourceHash="95e977b770ada91be1c66f481cba224994d91ad83c4c4d8573bc8dae730c959a"

__Persistable__source() {
  cat <<'__TRASHTALK_SOURCE_EOF__'
# Persistable trait - provides database persistence for objects
# Objects including this trait can be saved to and loaded from the Store (SQLite).
#
# Usage:
#   Counter subclass: Object
#     include: Persistable
#     instanceVars: value:0
#
#   # Create and save in one step
#   counter=$(@ Counter create)
#
#   # Or create, modify, then save
#   counter=$(@ Counter new)
#   @ $counter increment
#   @ $counter save
#
#   # Query persisted objects
#   @ Counter findAll           # All saved Counter instances
#   @ Counter find 'value > 5'  # Filtered query
#   @ Counter count             # Number of saved instances

Persistable trait

  # Save this object to the Store (idempotent - creates or updates)
  method: save [
    | data |
    data := @ Runtime dataFor: self
    @ Store put: self data: data
  ]

  # Delete this object from the Store (keeps it in memory)
  method: unpersist [
    @ Store deleteInstance: self
  ]

  # Delete this object from both memory and Store
  method: delete [
    @ Store deleteInstance: self
    @ Runtime delete: self
  ]

  # Check if this object is persisted in the Store
  method: isPersisted [
    ^ @ Store exists: self
  ]

  # Reload this object from the Store (discards in-memory changes)
  method: reload [
    | data |
    data := @ Store getInstance: self
    @ Runtime setData: data for: self
  ]

  # Return this object's data as JSON
  method: asJson [
    ^ @ Runtime dataFor: self
  ]

  # Create a new instance and immediately save it to the Store
  # Usage: counter=$(@ Counter create)
  classMethod: create [
    | id |
    id := @ self new
    @ id save
    ^ id
  ]

  # Return all persisted instance IDs for this class
  # Usage: @ Counter findAll
  classMethod: findAll [
    ^ @ Store findByClass: self
  ]

  # Return count of persisted instances for this class
  # Usage: @ Counter count
  classMethod: count [
    ^ @ Store countByClass: self
  ]

  # Find persisted instances matching a predicate
  # Usage: @ Counter find 'value > 5'
  # Supports: =, !=, >, <, >=, <=
  # When no predicate given, returns all (same as findAll)
  classMethod: find: predicate [
    predicate isEmpty ifTrue: [^ @ self findAll].
    ^ @ Store findByClass: self where: predicate
  ]

  # Load all persisted instances of this class into memory
  # Usage: @ Counter loadAll
  classMethod: loadAll [
    | ids arr |
    ids := @ Store findByClass: self.
    arr := @ Array fromLines: ids.
    arr do: [:id | @ id reload]
  ]

__TRASHTALK_SOURCE_EOF__
}

__Persistable__save() {
  local data
  data="$(@ Runtime dataFor_ $_RECEIVER)"
  $(@ Store put_data_ $_RECEIVER $data)
}

__Persistable__unpersist() {
  $(@ Store deleteInstance_ $_RECEIVER)
}

__Persistable__delete() {
  $(@ Store deleteInstance_ $_RECEIVER)
  $(@ Runtime delete_ $_RECEIVER)
}

__Persistable__isPersisted() {
  echo "$(@ Store exists_ $_RECEIVER)"; return
}

__Persistable__reload() {
  local data
  data="$(@ Store getInstance_ $_RECEIVER)"
  $(@ Runtime setData_for_ $data $_RECEIVER)
}

__Persistable__asJson() {
  echo "$(@ Runtime dataFor_ $_RECEIVER)"; return
}

__Persistable__class__create() {
  local id
  id="$(@ "$_RECEIVER" new)"
  $(@ "$id" save)
  echo "$id"; return
}

__Persistable__class__findAll() {
  echo "$(@ Store findByClass_ $_RECEIVER)"; return
}

__Persistable__class__count() {
  echo "$(@ Store countByClass_ $_RECEIVER)"; return
}

__Persistable__class__find_() {
  local predicate="$1"
  if [[ -n "$(@ "$predicate" isEmpty)" ]]; then
    echo "$(@ "$_RECEIVER" findAll)"; return
  fi
  echo "$(@ Store findByClass_where_ $_RECEIVER $predicate)"; return
}

__Persistable__class__loadAll() {
  local ids arr
  ids="$(@ Store findByClass_ $_RECEIVER)"
  arr="$(@ Array fromLines_ $ids)"
  for id in $arr; do
    $(@ "$id" reload)
  done
}

