#!/bin/bash
# Generated by Trashtalk Compiler - DO NOT EDIT
# Source: Object (base class)
# Hand-compiled to avoid namespace pollution

__Object__superclass=""
__Object__instanceVars=""
__Object__traits=""

# ============================================
# Class Methods
# ============================================

# Find all instances of this class
__Object__class__findAll() {
    db_find_by_class "$_CLASS"
}

# Find instances matching a predicate
__Object__class__find() {
    local predicate="$1"

    if [[ -z "$predicate" ]]; then
        db_find_by_class "$_CLASS"
        return 0
    fi

    local escaped_class
    escaped_class=$(_db_escape "$_CLASS")

    if [[ "$predicate" =~ ^([a-zA-Z_][a-zA-Z0-9_]*)[[:space:]]*([<>=!]+)[[:space:]]*(.+)$ ]]; then
        local field="${BASH_REMATCH[1]}"
        local op="${BASH_REMATCH[2]}"
        local target="${BASH_REMATCH[3]}"

        [[ "$op" == "==" ]] && op="="
        [[ "$op" == "!=" ]] && op="<>"

        local where_clause="class = '$escaped_class' AND json_extract(data, '\$.$field') $op $target"
        db_query "$where_clause"
    else
        echo "Error: Invalid predicate format: $predicate" >&2
        echo "Expected: field OP value (e.g. 'value > 5')" >&2
        return 1
    fi
}

# Count instances of this class
__Object__class__count() {
    db_count_by_class "$_CLASS"
}

# ============================================
# Instance Methods
# ============================================

# Save instance to database
__Object__save() {
    local data
    data=$(db_get "$_RECEIVER")
    if [[ -n "$data" ]]; then
        db_put "$_RECEIVER" "$data"
    else
        echo "Error: Instance $_RECEIVER not found" >&2
        return 1
    fi
}

# Delete this instance from database
__Object__delete() {
    db_delete "$_RECEIVER"
}

# Get the class of this instance
__Object__class() {
    _get_instance_class "$_RECEIVER"
}

# Get instance ID
__Object__id() {
    echo "$_RECEIVER"
}

# Get all data as JSON
__Object__asJson() {
    db_get "$_RECEIVER"
}

# Check if instance exists in database
__Object__exists() {
    local data
    data=$(db_get "$_RECEIVER" 2>/dev/null)
    [[ -n "$data" ]]
}

# Open the class definition in editor
__Object__edit() {
    local class_name
    local class_file

    if _is_instance "$_RECEIVER"; then
        class_name=$(_get_instance_class "$_RECEIVER")
    else
        class_name="$_RECEIVER"
    fi

    class_file="$TRASHDIR/$class_name"

    if [[ ! -f "$class_file" ]]; then
        echo "Error: Class file not found: $class_file" >&2
        return 1
    fi

    local editor="${EDITOR:-vi}"
    "$editor" "$class_file"
}

# Alias common methods for both instance and class receivers
# find can be called on both class and instance
__Object__find() {
    __Object__class__find "$@"
}

__Object__findAll() {
    __Object__class__findAll "$@"
}

__Object__count() {
    __Object__class__count "$@"
}
