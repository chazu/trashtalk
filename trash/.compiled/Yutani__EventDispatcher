#!/usr/bin/env bash
# Generated by Trashtalk Compiler (jq) - DO NOT EDIT
# Source: EventDispatcher.trash
# Generated: 2026-01-06T15:28:12

__Yutani__EventDispatcher__superclass="Object"
__Yutani__EventDispatcher__instanceVars="handlerFile: keyHandler: mouseHandler: resizeHandler: focusHandler: running:"
__Yutani__EventDispatcher__classInstanceVars=""
__Yutani__EventDispatcher__traits=""
__Yutani__EventDispatcher__sourceHash="1fa4d77c2ce621b2d7aea72785d0f01304de4e56a89317ee96962f81941f3548"
__Yutani__EventDispatcher__package="Yutani"
__Yutani__EventDispatcher__qualifiedName="Yutani::EventDispatcher"

__Yutani__EventDispatcher__source() {
  cat <<'__TRASHTALK_SOURCE_EOF__'
package: Yutani

EventDispatcher subclass: Object
  instanceVars: handlerFile:'' keyHandler:'' mouseHandler:'' resizeHandler:'' focusHandler:'' running:''

  # Create a new dispatcher
  rawClassMethod: new [
    local instance hfile
    instance=$(_generate_instance_id "Yutani__EventDispatcher")
    _create_instance "Yutani::EventDispatcher" "$instance"
    # Create unique handler file
    hfile="/tmp/yutani_handlers_${instance}.txt"
    touch "$hfile"
    @ "$instance" _setHandlerFile: "$hfile"
    @ "$instance" _setRunning: "true"
    echo "$instance"
  ]

  # Register a handler for a specific widget
  # Handler is a bash command that will be eval'd with $__EVENT set to the Event instance
  rawMethod: onWidget: widgetId do: handler [
    local widgetId="$1" handler="$2" hfile
    hfile="$(_ivar handlerFile)"
    # Remove any existing handler for this widget
    if [[ -f "$hfile" ]]; then
      grep -v "^${widgetId}:" "$hfile" > "${hfile}.tmp" 2>/dev/null || true
      mv "${hfile}.tmp" "$hfile"
    fi
    # Add new handler
    echo "${widgetId}:${handler}" >> "$hfile"
  ]

  # Register a global key handler
  # Handler receives $__EVENT
  rawMethod: onKeyDo: handler [
    local handler="$1"
    _ivar_set keyHandler "$handler"
  ]

  # Register a global mouse handler
  method: onMouseDo: handler [
    _ivar_set mouseHandler "$handler"
  ]

  # Register a global resize handler
  method: onResizeDo: handler [
    _ivar_set resizeHandler "$handler"
  ]

  # Register a global focus handler
  method: onFocusDo: handler [
    _ivar_set focusHandler "$handler"
  ]

  # Dispatch an event to the appropriate handler
  rawMethod: dispatch: event [
    pragma: direct
    local event="$1"
    local eventType widgetId handler hfile line

    eventType=$(@ "$event" eventType)

    case "$eventType" in
      key)
        handler="$(_ivar keyHandler)"
        if [[ -n "$handler" ]]; then
          __EVENT="$event"
          eval "$handler"
        fi
        ;;
      widget)
        widgetId=$(@ "$event" widgetId)
        hfile="$(_ivar handlerFile)"
        if [[ -f "$hfile" && -n "$widgetId" ]]; then
          # Find handler for this widget
          line=$(grep "^${widgetId}:" "$hfile" 2>/dev/null | head -1)
          if [[ -n "$line" ]]; then
            handler="${line#*:}"
            __EVENT="$event"
            eval "$handler"
          fi
        fi
        ;;
      mouse)
        handler="$(_ivar mouseHandler)"
        if [[ -n "$handler" ]]; then
          __EVENT="$event"
          eval "$handler"
        fi
        ;;
      resize)
        handler="$(_ivar resizeHandler)"
        if [[ -n "$handler" ]]; then
          __EVENT="$event"
          eval "$handler"
        fi
        ;;
      focus)
        handler="$(_ivar focusHandler)"
        if [[ -n "$handler" ]]; then
          __EVENT="$event"
          eval "$handler"
        fi
        ;;
    esac
  ]

  # Dispatch a raw JSON event (creates Event, then dispatches)
  rawMethod: dispatchJson: json [
    pragma: direct
    local json="$1" event

    # Skip non-JSON lines
    if ! echo "$json" | jq -e . >/dev/null 2>&1; then
      return
    fi

    event=$(@ Yutani::Event fromJson: "$json")
    @ "$_RECEIVER" dispatch: "$event"
  ]

  # Check if dispatcher is still running
  rawMethod: isRunning [
    _ivar running
  ]

  # Stop the dispatcher
  method: stop [
    _ivar_set running "false"
  ]

  # Remove a widget handler
  rawMethod: removeHandlerFor: widgetId [
    local widgetId="$1" hfile
    hfile="$(_ivar handlerFile)"
    if [[ -f "$hfile" ]]; then
      grep -v "^${widgetId}:" "$hfile" > "${hfile}.tmp" 2>/dev/null || true
      mv "${hfile}.tmp" "$hfile"
    fi
  ]

  # Clean up handler file
  rawMethod: cleanup [
    local hfile
    hfile="$(_ivar handlerFile)"
    rm -f "$hfile" 2>/dev/null
  ]

  # Private setters
  method: _setHandlerFile: v [ _ivar_set handlerFile "$v" ]
  method: _setRunning: v [ _ivar_set running "$v" ]
__TRASHTALK_SOURCE_EOF__
}

__Yutani__EventDispatcher__handlerFile() {
  echo "$(_ivar handlerFile)"; return
}

__Yutani__EventDispatcher__handlerFile_() {
  _ivar_set handlerFile "$1"
}

__Yutani__EventDispatcher__getHandlerFile() {
  echo "$(_ivar handlerFile)"; return
}

__Yutani__EventDispatcher__setHandlerFile_() {
  _ivar_set handlerFile "$1"
}
__Yutani__EventDispatcher__keyHandler() {
  echo "$(_ivar keyHandler)"; return
}

__Yutani__EventDispatcher__keyHandler_() {
  _ivar_set keyHandler "$1"
}

__Yutani__EventDispatcher__getKeyHandler() {
  echo "$(_ivar keyHandler)"; return
}

__Yutani__EventDispatcher__setKeyHandler_() {
  _ivar_set keyHandler "$1"
}
__Yutani__EventDispatcher__mouseHandler() {
  echo "$(_ivar mouseHandler)"; return
}

__Yutani__EventDispatcher__mouseHandler_() {
  _ivar_set mouseHandler "$1"
}

__Yutani__EventDispatcher__getMouseHandler() {
  echo "$(_ivar mouseHandler)"; return
}

__Yutani__EventDispatcher__setMouseHandler_() {
  _ivar_set mouseHandler "$1"
}
__Yutani__EventDispatcher__resizeHandler() {
  echo "$(_ivar resizeHandler)"; return
}

__Yutani__EventDispatcher__resizeHandler_() {
  _ivar_set resizeHandler "$1"
}

__Yutani__EventDispatcher__getResizeHandler() {
  echo "$(_ivar resizeHandler)"; return
}

__Yutani__EventDispatcher__setResizeHandler_() {
  _ivar_set resizeHandler "$1"
}
__Yutani__EventDispatcher__focusHandler() {
  echo "$(_ivar focusHandler)"; return
}

__Yutani__EventDispatcher__focusHandler_() {
  _ivar_set focusHandler "$1"
}

__Yutani__EventDispatcher__getFocusHandler() {
  echo "$(_ivar focusHandler)"; return
}

__Yutani__EventDispatcher__setFocusHandler_() {
  _ivar_set focusHandler "$1"
}
__Yutani__EventDispatcher__running() {
  echo "$(_ivar running)"; return
}

__Yutani__EventDispatcher__running_() {
  _ivar_set running "$1"
}

__Yutani__EventDispatcher__getRunning() {
  echo "$(_ivar running)"; return
}

__Yutani__EventDispatcher__setRunning_() {
  _ivar_set running "$1"
}

__Yutani__EventDispatcher__class__new() {
    local instance hfile
    instance=$(_generate_instance_id "Yutani__EventDispatcher")
    _create_instance "Yutani::EventDispatcher" "$instance"
    # Create unique handler file
    hfile="/tmp/yutani_handlers_${instance}.txt"
    touch "$hfile"
    @ "$instance" _setHandlerFile: "$hfile"
    @ "$instance" _setRunning: "true"
    echo "$instance"
}

__Yutani__EventDispatcher__onWidget_do_() {
  local widgetId="$1"
  local handler="$2"
    local widgetId="$1" handler="$2" hfile
    hfile="$(_ivar handlerFile)"
    # Remove any existing handler for this widget
    if [[ -f "$hfile" ]]; then
        grep -v "^${widgetId}:" "$hfile" >"${hfile}.tmp" 2>/dev/null || true
        mv "${hfile}.tmp" "$hfile"
    fi
    # Add new handler
    echo "${widgetId}:${handler}" >>"$hfile"
}

__Yutani__EventDispatcher__onKeyDo_() {
  local handler="$1"
    local handler="$1"
    _ivar_set keyHandler "$handler"
}

__Yutani__EventDispatcher__onMouseDo_() {
  local handler="$1"
  _ivar_set mouseHandler "$handler"
}

__Yutani__EventDispatcher__onResizeDo_() {
  local handler="$1"
  _ivar_set resizeHandler "$handler"
}

__Yutani__EventDispatcher__onFocusDo_() {
  local handler="$1"
  _ivar_set focusHandler "$handler"
}

declare -g __Yutani__EventDispatcher__dispatch___direct=1
__Yutani__EventDispatcher__dispatch_() {
  local event="$1"
    local event="$1"
    local eventType widgetId handler hfile line

    eventType=$(@ "$event" eventType)

    case "$eventType" in
        key)
        handler="$(_ivar keyHandler)"
        if [[ -n "$handler" ]]; then
            __EVENT="$event"
            eval "$handler"
        fi
    ;;
        widget)
        widgetId=$(@ "$event" widgetId)
        hfile="$(_ivar handlerFile)"
        if [[ -f "$hfile" && -n "$widgetId" ]]; then
            # Find handler for this widget
            line=$(grep "^${widgetId}:" "$hfile" 2>/dev/null | head -1)
            if [[ -n "$line" ]]; then
                handler="${line#*:}"
                __EVENT="$event"
                eval "$handler"
            fi
        fi
    ;;
        mouse)
        handler="$(_ivar mouseHandler)"
        if [[ -n "$handler" ]]; then
            __EVENT="$event"
            eval "$handler"
        fi
    ;;
        resize)
        handler="$(_ivar resizeHandler)"
        if [[ -n "$handler" ]]; then
            __EVENT="$event"
            eval "$handler"
        fi
    ;;
        focus)
        handler="$(_ivar focusHandler)"
        if [[ -n "$handler" ]]; then
            __EVENT="$event"
            eval "$handler"
        fi
    ;;
    esac
}

declare -g __Yutani__EventDispatcher__dispatchJson___direct=1
__Yutani__EventDispatcher__dispatchJson_() {
  local json="$1"
    local json="$1" event

    # Skip non-JSON lines
    if ! echo "$json" | jq -e . >/dev/null 2>&1; then
        return
    fi

    event=$(@ Yutani::Event fromJson: "$json")
    @ "$_RECEIVER" dispatch: "$event"
}

__Yutani__EventDispatcher__isRunning() {
    _ivar running
}

__Yutani__EventDispatcher__stop() {
  _ivar_set running "false"
}

__Yutani__EventDispatcher__removeHandlerFor_() {
  local widgetId="$1"
    local widgetId="$1" hfile
    hfile="$(_ivar handlerFile)"
    if [[ -f "$hfile" ]]; then
        grep -v "^${widgetId}:" "$hfile" >"${hfile}.tmp" 2>/dev/null || true
        mv "${hfile}.tmp" "$hfile"
    fi
}

__Yutani__EventDispatcher__cleanup() {
    local hfile
    hfile="$(_ivar handlerFile)"
    rm -f "$hfile" 2>/dev/null
}

__Yutani__EventDispatcher___setHandlerFile_() {
  local v="$1"
  _ivar_set handlerFile "$v"
}

__Yutani__EventDispatcher___setRunning_() {
  local v="$1"
  _ivar_set running "$v"
}
