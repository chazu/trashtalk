#!/usr/bin/env bash
# Generated by Trashtalk Compiler (jq) - DO NOT EDIT
# Source: EventDispatcher.trash
# Generated: 2026-01-12T22:52:39

__Yutani__EventDispatcher__superclass="Object"
__Yutani__EventDispatcher__instanceVars="keyHandler: mouseHandler: resizeHandler: focusHandler: running:"
__Yutani__EventDispatcher__classInstanceVars=""
__Yutani__EventDispatcher__traits=""
__Yutani__EventDispatcher__sourceHash="113d9bc8f31a01d5f3e6d061e03943cecfdf3c7783272e5f66dbcdcc8b019665"
__Yutani__EventDispatcher__package="Yutani"
__Yutani__EventDispatcher__qualifiedName="Yutani::EventDispatcher"

__Yutani__EventDispatcher__source() {
  cat <<'__TRASHTALK_SOURCE_EOF__'
package: Yutani

# EventDispatcher - routes UI events to widget handlers
# Refactored to use Bash associative array for O(1) handler lookup

EventDispatcher subclass: Object
  instanceVars: keyHandler:'' mouseHandler:'' resizeHandler:'' focusHandler:'' running:''

  # ============================================================================
  # Initialization
  # ============================================================================

  # Create a new dispatcher with its own handler registry
  classMethod: new [
    pragma: primitive
    local instance
    instance=$(_generate_instance_id "Yutani__EventDispatcher")
    _create_instance "Yutani::EventDispatcher" "$instance"
    @ "$instance" _setRunning: "true"
    echo "$instance"
  ]

  # ============================================================================
  # Widget Handler Registration
  # ============================================================================

  # Register a handler for a specific widget
  # Handler is a bash command that will be eval'd with $__EVENT set
  # Uses file-based storage to survive subshell boundaries
  method: onWidget: widgetId do: handler [
    pragma: primitive
    local widgetId="$1" handler="$2"
    local handlerFile="/tmp/yutani_handler_${widgetId}.txt"
    echo "$handler" > "$handlerFile"
  ]

  # Remove handler for a widget
  method: removeHandlerFor: widgetId [
    pragma: primitive
    local widgetId="$1"
    local handlerFile="/tmp/yutani_handler_${widgetId}.txt"
    rm -f "$handlerFile"
  ]

  # ============================================================================
  # Global Event Handlers
  # ============================================================================

  # Register a global key handler
  method: onKeyDo: handler [
    keyHandler := handler
  ]

  # Register a global mouse handler
  method: onMouseDo: handler [
    mouseHandler := handler
  ]

  # Register a global resize handler
  method: onResizeDo: handler [
    resizeHandler := handler
  ]

  # Register a global focus handler
  method: onFocusDo: handler [
    focusHandler := handler
  ]

  # ============================================================================
  # Event Dispatch
  # ============================================================================

  # Dispatch an event to the appropriate handler
  method: dispatch: event [
    pragma: primitive
    pragma: direct
    local event="$1"
    local eventType widgetId handler

    eventType=$(@ "$event" eventType)

    case "$eventType" in
      key)
        handler="$(_ivar keyHandler)"
        if [[ -n "$handler" ]]; then
          __EVENT="$event"
          eval "$handler"
        fi
        ;;
      widget)
        widgetId=$(@ "$event" widgetId)
        if [[ -n "$widgetId" ]]; then
          local handlerFile="/tmp/yutani_handler_${widgetId}.txt"
          if [[ -f "$handlerFile" ]]; then
            handler=$(cat "$handlerFile")
            if [[ -n "$handler" ]]; then
              __EVENT="$event"
              eval "$handler"
            fi
          fi
        fi
        ;;
      mouse)
        handler="$(_ivar mouseHandler)"
        if [[ -n "$handler" ]]; then
          __EVENT="$event"
          eval "$handler"
        fi
        ;;
      resize)
        handler="$(_ivar resizeHandler)"
        if [[ -n "$handler" ]]; then
          __EVENT="$event"
          eval "$handler"
        fi
        ;;
      focus)
        handler="$(_ivar focusHandler)"
        if [[ -n "$handler" ]]; then
          __EVENT="$event"
          eval "$handler"
        fi
        ;;
    esac
  ]

  # Dispatch a raw JSON event (creates Event, then dispatches)
  method: dispatchJson: json [
    pragma: primitive
    pragma: direct
    local json="$1" event

    # Skip non-JSON lines
    if ! echo "$json" | jq -e . >/dev/null 2>&1; then
      return
    fi

    event=$(@ Yutani::Event fromJson: "$json")
    @ "$_RECEIVER" dispatch: "$event"
  ]

  # ============================================================================
  # Lifecycle
  # ============================================================================

  # Check if dispatcher is still running
  method: isRunning [
    ^ running
  ]

  # Stop the dispatcher
  method: stop [
    running := 'false'
  ]

  # Clean up all handlers for this dispatcher
  method: cleanup [
    pragma: primitive
    # Remove all handler files (simple cleanup - removes all yutani handlers)
    rm -f /tmp/yutani_handler_*.txt 2>/dev/null
    rm -f /tmp/yutani_text_*.txt 2>/dev/null
  ]

  # ============================================================================
  # Private Setters
  # ============================================================================

  method: _setRunning: v [ running := v ]
__TRASHTALK_SOURCE_EOF__
}

__Yutani__EventDispatcher__keyHandler() {
  echo "$(_ivar keyHandler)"; return
}

__Yutani__EventDispatcher__keyHandler_() {
  _ivar_set keyHandler "$1"
}

__Yutani__EventDispatcher__getKeyHandler() {
  echo "$(_ivar keyHandler)"; return
}

__Yutani__EventDispatcher__setKeyHandler_() {
  _ivar_set keyHandler "$1"
}
__Yutani__EventDispatcher__mouseHandler() {
  echo "$(_ivar mouseHandler)"; return
}

__Yutani__EventDispatcher__mouseHandler_() {
  _ivar_set mouseHandler "$1"
}

__Yutani__EventDispatcher__getMouseHandler() {
  echo "$(_ivar mouseHandler)"; return
}

__Yutani__EventDispatcher__setMouseHandler_() {
  _ivar_set mouseHandler "$1"
}
__Yutani__EventDispatcher__resizeHandler() {
  echo "$(_ivar resizeHandler)"; return
}

__Yutani__EventDispatcher__resizeHandler_() {
  _ivar_set resizeHandler "$1"
}

__Yutani__EventDispatcher__getResizeHandler() {
  echo "$(_ivar resizeHandler)"; return
}

__Yutani__EventDispatcher__setResizeHandler_() {
  _ivar_set resizeHandler "$1"
}
__Yutani__EventDispatcher__focusHandler() {
  echo "$(_ivar focusHandler)"; return
}

__Yutani__EventDispatcher__focusHandler_() {
  _ivar_set focusHandler "$1"
}

__Yutani__EventDispatcher__getFocusHandler() {
  echo "$(_ivar focusHandler)"; return
}

__Yutani__EventDispatcher__setFocusHandler_() {
  _ivar_set focusHandler "$1"
}
__Yutani__EventDispatcher__running() {
  echo "$(_ivar running)"; return
}

__Yutani__EventDispatcher__running_() {
  _ivar_set running "$1"
}

__Yutani__EventDispatcher__getRunning() {
  echo "$(_ivar running)"; return
}

__Yutani__EventDispatcher__setRunning_() {
  _ivar_set running "$1"
}

__Yutani__EventDispatcher__class__new() {
    local instance
    instance=$(_generate_instance_id "Yutani__EventDispatcher")
    _create_instance "Yutani::EventDispatcher" "$instance"
    @ "$instance" _setRunning: "true"
    echo "$instance"
}

__Yutani__EventDispatcher__onWidget_do_() {
  local widgetId="$1"
  local handler="$2"
    local widgetId="$1" handler="$2"
    local handlerFile="/tmp/yutani_handler_${widgetId}.txt"
    echo "$handler" >"$handlerFile"
}

__Yutani__EventDispatcher__removeHandlerFor_() {
  local widgetId="$1"
    local widgetId="$1"
    local handlerFile="/tmp/yutani_handler_${widgetId}.txt"
    rm -f "$handlerFile"
}

__Yutani__EventDispatcher__onKeyDo_() {
  local handler="$1"
  _ivar_set keyHandler "$handler"
}

__Yutani__EventDispatcher__onMouseDo_() {
  local handler="$1"
  _ivar_set mouseHandler "$handler"
}

__Yutani__EventDispatcher__onResizeDo_() {
  local handler="$1"
  _ivar_set resizeHandler "$handler"
}

__Yutani__EventDispatcher__onFocusDo_() {
  local handler="$1"
  _ivar_set focusHandler "$handler"
}

declare -g __Yutani__EventDispatcher__dispatch___direct=1
__Yutani__EventDispatcher__dispatch_() {
  local event="$1"
    local event="$1"
    local eventType widgetId handler

    eventType=$(@ "$event" eventType)

    case "$eventType" in
        key)
        handler="$(_ivar keyHandler)"
        if [[ -n "$handler" ]]; then
            __EVENT="$event"
            eval "$handler"
        fi
    ;;
        widget)
        widgetId=$(@ "$event" widgetId)
        if [[ -n "$widgetId" ]]; then
            local handlerFile="/tmp/yutani_handler_${widgetId}.txt"
            if [[ -f "$handlerFile" ]]; then
                handler=$(cat "$handlerFile")
                if [[ -n "$handler" ]]; then
                    __EVENT="$event"
                    eval "$handler"
                fi
            fi
        fi
    ;;
        mouse)
        handler="$(_ivar mouseHandler)"
        if [[ -n "$handler" ]]; then
            __EVENT="$event"
            eval "$handler"
        fi
    ;;
        resize)
        handler="$(_ivar resizeHandler)"
        if [[ -n "$handler" ]]; then
            __EVENT="$event"
            eval "$handler"
        fi
    ;;
        focus)
        handler="$(_ivar focusHandler)"
        if [[ -n "$handler" ]]; then
            __EVENT="$event"
            eval "$handler"
        fi
    ;;
    esac
}

declare -g __Yutani__EventDispatcher__dispatchJson___direct=1
__Yutani__EventDispatcher__dispatchJson_() {
  local json="$1"
    local json="$1" event

    # Skip non-JSON lines
    if ! echo "$json" | jq -e . >/dev/null 2>&1; then
        return
    fi

    event=$(@ Yutani::Event fromJson: "$json")
    @ "$_RECEIVER" dispatch: "$event"
}

__Yutani__EventDispatcher__isRunning() {
  echo "$(_ivar running)"; return
}

__Yutani__EventDispatcher__stop() {
  _ivar_set running "false"
}

__Yutani__EventDispatcher__cleanup() {
    # Remove all handler files (simple cleanup - removes all yutani handlers)
    rm -f /tmp/yutani_handler_*.txt 2>/dev/null
    rm -f /tmp/yutani_text_*.txt 2>/dev/null
}

__Yutani__EventDispatcher___setRunning_() {
  local v="$1"
  _ivar_set running "$v"
}
